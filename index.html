<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">
    <meta name="description" content="Voice-powered diamond requirement form with AI parsing and mobile optimization">
    <meta name="keywords" content="diamond, requirements, voice input, AI, Gemini, OpenAI">
    <meta name="author" content="Diamond Requirements App">
    <title>Diamond Requirements - Multi-Page App</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Mobile-optimized base styles */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body {
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Improved touch targets for mobile */
        button, input, select, textarea {
            touch-action: manipulation;
            min-height: 44px; /* iOS recommended minimum */
        }
        
        /* Better scrolling on mobile */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        .active-field-glow {
            animation: pulse-glow 2s infinite;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .animate-fade-out {
            animation: fade-out 2s ease-out forwards;
        }
        
        @keyframes fade-out {
            0% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            70% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -20px) scale(0.95); }
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 640px) {
            /* Larger text for readability */
            body {
                font-size: 16px; /* Prevents iOS zoom on input focus */
            }
            
            /* Better button sizes for touch */
            button {
                min-height: 48px;
                padding: 12px 16px;
            }
            
            /* Input fields optimization */
            input, textarea, select {
                font-size: 16px; /* Prevents iOS zoom */
                min-height: 48px;
            }
            
            /* Reduce excessive spacing on small screens */
            .mobile-compact {
                padding: 8px !important;
                margin: 4px 0 !important;
            }
            
            /* Mobile download optimization */
            a[download] {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Ensure proper touch targets */
            .download-btn, .share-btn {
                min-height: 50px;
                font-size: 16px;
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Configuration
        // Detect if running on Vercel (production) or locally
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        
        // For LOCAL: Replace with your API keys (if testing locally with direct API access)
        // For VERCEL: Uses serverless functions (API keys are stored in environment variables)
        const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY_HERE';  // Only used for local testing
        const OPENAI_API_URL = isProduction 
            ? '/api/transcribe'  // Serverless function on Vercel (uses OPENAI_API_KEY from env)
            : 'https://api.openai.com/v1/audio/transcriptions';  // Direct API locally
        
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';  // Only used for local testing
        const GEMINI_API_URL = isProduction
            ? '/api/gemini'  // Serverless function on Vercel (uses GEMINI_API_KEY from env)
            : `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;  // Direct API locally

        // Supabase Configuration
        const SUPABASE_URL = 'https://wpyupttzyprrimzzzmpe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweXVwdHR6eXBycmltenp6bXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzIyNzksImV4cCI6MjA3NjA0ODI3OX0.ApA89wrI1adaXDaGJiKABmOCHLR7vbca6OjnfDv3KPI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Initial form state
        const initialFormState = {
            shape: '',
            sizes_mm: '',
            color: '',
            clarity: '',
            carats_ct: '',
            price_target_inr: '',
            notes: ''
        };

        // Supabase Functions
        const saveDiamondRequirement = async (requirementData, mobileNumber = null) => {
            try {
                console.log('üíæ Saving to Supabase:', requirementData);
                const { data, error } = await supabase
                    .from('diamond_requirements')
                    .insert([{
                        shape: requirementData.shape || null,
                        sizes_mm: requirementData.sizes_mm || null,
                        color: requirementData.color || null,
                        clarity: requirementData.clarity || null,
                        carats_ct: requirementData.carats_ct || null,
                        price_target_inr: requirementData.price_target_inr || null,
                        notes: requirementData.notes || null,
                        mobile_number: mobileNumber || null
                    }])
                    .select();
                if (error) { console.error('‚ùå Supabase error:', error); throw error; }
                console.log('‚úÖ Successfully saved to Supabase:', data);
                return data;
            } catch (error) { console.error('‚ùå Error saving to Supabase:', error); throw error; }
        };

        const saveMobileNumber = async (mobileNumber) => {
            try {
                console.log('üì± Saving mobile number to Supabase:', mobileNumber);
                
                // First, check if the mobile number already exists
                const { data: existingData, error: checkError } = await supabase
                    .from('mobile_numbers')
                    .select('mobile_number')
                    .eq('mobile_number', mobileNumber)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                    console.error('‚ùå Error checking existing mobile number:', checkError);
                    throw checkError;
                }
                
                // If mobile number already exists, return success without inserting
                if (existingData) {
                    console.log('‚úÖ Mobile number already exists in database:', mobileNumber);
                    return existingData;
                }
                
                // If mobile number doesn't exist, insert it
                const { data, error } = await supabase
                    .from('mobile_numbers')
                    .insert([{ mobile_number: mobileNumber }])
                    .select();
                    
                if (error) { 
                    console.error('‚ùå Supabase mobile error:', error); 
                    throw error; 
                }
                
                console.log('‚úÖ Successfully saved mobile number:', data);
                return data;
            } catch (error) { 
                console.error('‚ùå Error saving mobile number:', error); 
                throw error; 
            }
        };

        // Fetch user deals by mobile number
        const fetchUserDeals = async (mobileNumber) => {
            try {
                console.log('üîç Searching deals for mobile:', mobileNumber);
                const { data, error } = await supabase
                    .from('diamond_requirements')
                    .select('*')
                    .eq('mobile_number', mobileNumber)
                    .order('created_at', { ascending: false });
                if (error) { console.error('‚ùå Error fetching user deals:', error); throw error; }
                console.log('‚úÖ User deals fetched:', data);
                return data;
            } catch (error) { console.error('‚ùå Error fetching user deals:', error); throw error; }
        };

        // Fetch all deals for admin
        const fetchAllDeals = async () => {
            try {
                console.log('üìä Fetching all deals for admin');
                const { data, error } = await supabase
                    .from('diamond_requirements')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) { console.error('‚ùå Error fetching all deals:', error); throw error; }
                console.log('‚úÖ All deals fetched:', data);
                return data;
            } catch (error) { console.error('‚ùå Error fetching all deals:', error); throw error; }
        };

        // Navigation Component
        const Navigation = ({ currentPage, setCurrentPage, showMobileMenu, setShowMobileMenu }) => (
            <nav className="bg-gray-800 border-b border-gray-700">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        {/* Logo */}
                        <div className="flex items-center">
                            <div className="flex-shrink-0">
                                <div className="w-8 h-8 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center">
                                    <i className="fas fa-gem text-white text-sm"></i>
                    </div>
                                </div>
                            <div className="ml-3">
                                <h1 className="text-white font-bold text-lg">Diamond Hub</h1>
                    </div>
                        </div>

                        {/* Desktop Navigation */}
                        <div className="hidden md:block">
                            <div className="ml-10 flex items-baseline space-x-4">
                                <button
                                    onClick={() => setCurrentPage('home')}
                                    className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                                        currentPage === 'home'
                                            ? 'bg-yellow-600 text-white'
                                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                    }`}
                                >
                                    üè† Home
                                </button>
                                <button
                                    onClick={() => setCurrentPage('deals')}
                                    className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                                        currentPage === 'deals'
                                            ? 'bg-yellow-600 text-white'
                                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                    }`}
                                >
                                    üíé My Deals
                                </button>
                                <button
                                    onClick={() => setCurrentPage('admin')}
                                    className={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                                        currentPage === 'admin'
                                            ? 'bg-yellow-600 text-white'
                                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                    }`}
                                >
                                    üîê Admin
                    </button>
                </div>
                        </div>

                        {/* Mobile menu button */}
                        <div className="md:hidden">
                            <button
                                onClick={() => setShowMobileMenu(!showMobileMenu)}
                                className="text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-md"
                            >
                                <i className="fas fa-bars text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>

                {/* Mobile Navigation */}
                {showMobileMenu && (
                    <div className="md:hidden">
                        <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-gray-900">
                            <button
                                onClick={() => {
                                    setCurrentPage('home');
                                    setShowMobileMenu(false);
                                }}
                                className={`block px-3 py-2 rounded-md text-base font-medium w-full text-left ${
                                    currentPage === 'home'
                                        ? 'bg-yellow-600 text-white'
                                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                }`}
                            >
                                üè† Home
                            </button>
                            <button
                                onClick={() => {
                                    setCurrentPage('deals');
                                    setShowMobileMenu(false);
                                }}
                                className={`block px-3 py-2 rounded-md text-base font-medium w-full text-left ${
                                    currentPage === 'deals'
                                        ? 'bg-yellow-600 text-white'
                                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                }`}
                            >
                                üíé My Deals
                            </button>
                            <button
                                onClick={() => {
                                    setCurrentPage('admin');
                                    setShowMobileMenu(false);
                                }}
                                className={`block px-3 py-2 rounded-md text-base font-medium w-full text-left ${
                                    currentPage === 'admin'
                                        ? 'bg-yellow-600 text-white'
                                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                }`}
                            >
                                üîê Admin
                            </button>
                        </div>
                    </div>
                )}
            </nav>
        );

        // Home Page Component
        const HomePage = () => {
            const [formState, setFormState] = useState(initialFormState);
            const [submittedData, setSubmittedData] = useState(null);
            const [error, setError] = useState('');
            const [showMobilePopup, setShowMobilePopup] = useState(false);
            const [mobileNumber, setMobileNumber] = useState('');
            const [isRecordingMobile, setIsRecordingMobile] = useState(false);
            const [mobileTranscript, setMobileTranscript] = useState('');
            const [isProcessingMobile, setIsProcessingMobile] = useState(false);
            const [showRequirementTicket, setShowRequirementTicket] = useState(false);
            const [savedRequirement, setSavedRequirement] = useState(null);
            const [ticketNumber, setTicketNumber] = useState('');
            const [showClosePopup, setShowClosePopup] = useState(false);
            
            // Voice functionality state
            const [isRecording, setIsRecording] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [voiceTranscript, setVoiceTranscript] = useState('');
            const [showVoiceInstructions, setShowVoiceInstructions] = useState(false);
            const [showTextFallback, setShowTextFallback] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('checking');
            const [guidedMode, setGuidedMode] = useState(false);
            const [currentFieldIndex, setCurrentFieldIndex] = useState(0);
            const [guidedPrompt, setGuidedPrompt] = useState('');
            const [conversationActive, setConversationActive] = useState(false);
            const [conversationHistory, setConversationHistory] = useState([]);
            const [autoVoiceMode, setAutoVoiceMode] = useState(false);
            const [autoPrompt, setAutoPrompt] = useState('');

            // Audio recording refs
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const recordingTimeoutRef = useRef(null);
            const advanceTimeoutRef = useRef(null);
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const sourceNodeRef = useRef(null);
            const silenceRAFRef = useRef(null);
            const lastVoiceTsRef = useRef(0);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormState(prevState => ({ ...prevState, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const newRequirement = Object.entries(formState)
                    .filter(([key, value]) => String(value).trim() !== '')
                    .reduce((obj, [key, value]) => ({...obj, [key]: value}), {});

                if (Object.keys(newRequirement).length > 0) {
                    setSubmittedData(newRequirement);
                    setError('');
                    setShowMobilePopup(true);
                } else {
                    setError("Cannot submit an empty form. Please fill at least one field.");
                    setTimeout(() => setError(''), 3000);
                }
            };

            const handleClear = () => {
                setFormState(initialFormState);
                setSubmittedData(null);
            };

            // Handle new requirement - refresh everything
            const handleNewRequirement = async () => {
                // Reset all form data
                setFormState(initialFormState);
                setSubmittedData(null);
                setShowRequirementTicket(false);
                setSavedRequirement(null);
                setTicketNumber('');
                setShowClosePopup(false);
                
                // Reset voice states
                setIsRecording(false);
                setIsProcessing(false);
                setVoiceTranscript('');
                setError('');
                setAutoVoiceMode(false);
                setShowVoiceInstructions(false);
                setShowTextFallback(false);
                setConnectionStatus('checking');
                setGuidedMode(false);
                setCurrentFieldIndex(0);
                setGuidedPrompt('');
                setConversationActive(false);
                setConversationHistory([]);
                
                // Reset mobile popup states
                setShowMobilePopup(false);
                setMobileNumber('');
                setIsRecordingMobile(false);
                setMobileTranscript('');
                setIsProcessingMobile(false);
                
                // Stop any ongoing recordings
                if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                    mediaRecorderRef.current.stop();
                }
                if (recordingTimeoutRef.current) {
                    clearTimeout(recordingTimeoutRef.current);
                }
                if (advanceTimeoutRef.current) {
                    clearTimeout(advanceTimeoutRef.current);
                }
                if (silenceRAFRef.current) {
                    cancelAnimationFrame(silenceRAFRef.current);
                }
                
                // Clear audio context
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                    audioContextRef.current = null;
                }
                
                console.log('üîÑ New requirement started - everything reset');
                
                // Re-activate voice mode after reset
                setTimeout(async () => {
                    setAutoVoiceMode(true);
                    const gujaratiPrompt = '‡™µ‡´â‡™á‡™∏ ‡™Æ‡´ã‡™° ‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™•‡™Ø‡´ã ‡™õ‡´á. ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™°‡™æ‡™Ø‡™Æ‡™Ç‡™°‡™®‡´Ä ‡™ú‡™∞‡´Ç‡™∞‡™ø‡™Ø‡™æ‡™§‡´ã ‡™ú‡™£‡™æ‡™µ‡´ã.';
                    const englishPrompt = 'Voice mode activated. Tell me all your diamond requirements.';
                    const bilingualEndPrompt = '‡™ú‡´ç‡™Ø‡™æ‡™∞‡´á ‡™§‡™Æ‡´á ‡™™‡´Ç‡™∞‡´ç‡™£ ‡™ï‡™∞‡´ã ‡™§‡´ç‡™Ø‡™æ‡™∞‡´á ‡™ï‡™π‡´ã. When you are done, say stop to process.';

                    await speakAsync(gujaratiPrompt, { interrupt: true, rate: 1.1 });
                    await speakAsync(englishPrompt, { rate: 1.1 });
                    await speakAsync(bilingualEndPrompt, { rate: 1.0 });

                    setTimeout(() => {
                        setAutoVoiceMode(false);
                    }, 2000);

                    setTimeout(() => {
                        startAudioRecording();
                    }, 500);
                }, 500);
            };

            // Handle close ticket with popup
            const handleCloseTicket = () => {
                setShowClosePopup(true);
            };

            // Handle close popup options
            const handleClosePopupOption = (option) => {
                setShowClosePopup(false);
                
                if (option === 'new') {
                    handleNewRequirement();
                } else if (option === 'stop') {
                    // Just close the ticket and stop voice
                    setShowRequirementTicket(false);
                    setSavedRequirement(null);
                    setTicketNumber('');
                    
                    // Stop voice recording
                    setIsRecording(false);
                    setAutoVoiceMode(false);
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                        mediaRecorderRef.current.stop();
                    }
                    console.log('üõë Voice stopped and ticket closed');
                }
            };

            // COMPREHENSIVE Mobile Download - Tries EVERY possible method
            const comprehensiveMobileDownload = async (canvas, requirement) => {
                const dataUrl = canvas.toDataURL('image/png');
                const filename = `diamond-ticket-${requirement.ticketNumber || Date.now()}.png`;
                
                // Convert dataURL to blob
                const blob = await (async (durl) => {
                    const parts = durl.split(',');
                    const meta = parts[0];
                    const isBase64 = meta.indexOf('base64') !== -1;
                    const mime = meta.split(':')[1].split(';')[0];
                    const raw = isBase64 ? atob(parts[1]) : decodeURIComponent(parts[1]);
                    const u8 = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; ++i) u8[i] = raw.charCodeAt(i);
                    return new Blob([u8], { type: mime });
                })(dataUrl);

                // Detection
                const isTelegram = window.Telegram && window.Telegram.WebApp;
                const isTelegramUA = /Telegram/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                console.log('üîç Platform Detection:', { isTelegram, isTelegramUA, isIOS, isAndroid, isMobile });

                // METHOD 1: Telegram WebApp API (if in Telegram)
                if (isTelegram && window.Telegram.WebApp.sendData) {
                    try {
                        console.log('üì± Trying Telegram WebApp API...');
                        const base64Data = dataUrl.split(',')[1];
                        window.Telegram.WebApp.sendData(base64Data);
                        alert('‚úÖ Ticket sent to Telegram! Check your chat.');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Telegram WebApp API failed:', err);
                    }
                }

                // METHOD 2: Web Share API with Files (Best for Android Chrome)
                if (navigator.canShare && navigator.canShare({ files: [] })) {
                    try {
                        console.log('üì± Trying Web Share API with files...');
                        await navigator.share({
                            files: [new File([blob], filename, { type: 'image/png' })],
                            title: 'Diamond Requirement Ticket',
                            text: `Diamond Ticket #${requirement.ticketNumber || 'N/A'}`
                        });
                        alert('‚úÖ Ticket shared successfully!');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Web Share API failed:', err);
                    }
                }

                // METHOD 3: Web Share API with Text + Data URL (Fallback)
                if (navigator.share) {
                    try {
                        console.log('üì± Trying Web Share API with text...');
                        await navigator.share({
                            title: 'Diamond Requirement Ticket',
                            text: `Diamond Ticket #${requirement.ticketNumber || 'N/A'}\n\nImage: ${dataUrl}`,
                            url: dataUrl
                        });
                        alert('‚úÖ Ticket shared successfully!');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Web Share API text failed:', err);
                    }
                }

                // METHOD 4: Programmatic Download (Standard method)
                try {
                    console.log('üì± Trying programmatic download...');
                    const objectUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
                    
                    // Check if download worked (heuristic)
                    setTimeout(() => {
                        alert('‚úÖ Download started! Check your downloads folder.');
                    }, 500);
                    return;
                } catch (err) {
                    console.warn('‚ùå Programmatic download failed:', err);
                }

                // METHOD 5: Data URL Download (Alternative)
                try {
                    console.log('üì± Trying data URL download...');
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    setTimeout(() => {
                        alert('‚úÖ Download started! Check your downloads folder.');
                    }, 500);
                    return;
                } catch (err) {
                    console.warn('‚ùå Data URL download failed:', err);
                }

                // METHOD 6: Open in New Tab (Universal fallback)
                try {
                    console.log('üì± Opening image in new tab...');
                    const objectUrl = URL.createObjectURL(blob);
                    const newWindow = window.open(objectUrl, '_blank');
                    
                    if (newWindow) {
                        // Show instructions
                        setTimeout(() => {
                            alert('üì± Image opened in new tab!\n\nTo save:\n‚Ä¢ Long-press the image\n‚Ä¢ Select "Save to Photos" or "Download"\n\nTo share:\n‚Ä¢ Long-press the image\n‚Ä¢ Select "Share"');
                        }, 1000);
                    } else {
                        throw new Error('Popup blocked');
                    }
                    return;
                } catch (err) {
                    console.warn('‚ùå New tab failed:', err);
                }

                // METHOD 7: Clipboard API (if supported)
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        console.log('üì± Trying clipboard...');
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        alert('‚úÖ Image copied to clipboard!\n\nYou can now paste it in any app.');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Clipboard failed:', err);
                    }
                }

                // METHOD 8: Manual Instructions (Last resort)
                console.log('üì± All methods failed, showing manual instructions...');
                const manualInstructions = `
üì± MOBILE RESTRICTIONS NOTICE:

Due to mobile browser restrictions, the ticket cannot be automatically saved. Here's what you can do:

üì∏ RECOMMENDED: Take a Screenshot
‚Ä¢ Take a screenshot of this ticket
‚Ä¢ Crop to just the ticket area
‚Ä¢ Save to your photos/gallery

üìã ALTERNATIVE: Check My Deals Page
‚Ä¢ Go to "My Deals" page in this app
‚Ä¢ View all your previous diamond requirements
‚Ä¢ Your ticket data is saved there automatically

üåê BROWSER METHOD (if screenshot doesn't work):
‚Ä¢ Long-press on the ticket
‚Ä¢ Select "Save Image" or "Download"
‚Ä¢ Check your downloads/photos

üí° TIP: Your requirement is automatically saved to the database, so you can always find it in the "My Deals" page!

Ticket Data:
${JSON.stringify(requirement, null, 2)}
                `;
                
                alert(manualInstructions);
            };

            // COMPREHENSIVE Mobile PNG Download/Share - Works in ANY format
            const downloadTicketAsPNG = async () => {
                try {
                    // Check if mobile and show restrictions notice
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        const mobileNotice = confirm(`
üì± MOBILE NOTICE:

Due to mobile browser restrictions, automatic download may not work.

‚úÖ RECOMMENDED: Take a screenshot of the ticket
‚úÖ ALTERNATIVE: Check "My Deals" page for saved requirements

Click OK to try automatic download, or Cancel to take a screenshot instead.
                        `);
                        
                        if (!mobileNotice) {
                            alert('üì∏ Great! Take a screenshot of the ticket and save it to your photos. You can also check your saved requirements in the "My Deals" page.');
                            return;
                        }
                    }

                    const ticketElement = document.getElementById('requirement-ticket');
                    if (!ticketElement) {
                        alert('‚ùå Ticket element not found');
                        return;
                    }

                    // Show loading indicator
                    const loadingMsg = document.createElement('div');
                    loadingMsg.innerHTML = 'üîÑ Generating PNG...';
                    loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;color:#fff;padding:20px;border-radius:10px;z-index:9999;';
                    document.body.appendChild(loadingMsg);

                    // Use html2canvas library to convert HTML to canvas
                    const canvas = await html2canvas(ticketElement, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        width: ticketElement.offsetWidth,
                        height: ticketElement.offsetHeight,
                        scrollX: 0,
                        scrollY: 0
                    });

                    // Remove loading indicator
                    document.body.removeChild(loadingMsg);

                    // COMPREHENSIVE Mobile Solution - Try EVERY possible method
                    await comprehensiveMobileDownload(canvas, savedRequirement);
                    
                } catch (error) {
                    console.error('Error downloading ticket:', error);
                    alert('‚ùå Failed to download ticket. Please try again.');
                }
            };

            // Telegram WebApp download handler
            const handleTelegramDownload = async (canvas, requirement) => {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    // Method 1: Try Telegram WebApp API if available
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
                        try {
                            // Convert canvas to blob for Telegram
                            const blob = await new Promise(resolve => {
                                canvas.toBlob(resolve, 'image/png', 0.9);
                            });
                            
                            // Try to send as file (if supported)
                            const reader = new FileReader();
                            reader.onload = function() {
                                const base64 = reader.result.split(',')[1];
                                window.Telegram.WebApp.sendData(base64);
                            };
                            reader.readAsDataURL(blob);
                            
                            alert('‚úÖ Ticket sent to Telegram! Check your chat.');
                            return;
                        } catch (telegramError) {
                            console.log('Telegram API failed, using fallback:', telegramError);
                        }
                    }
                    
                    // Method 2: Open image in new window for manual save
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Save Ticket #${requirement.ticket_number}</title>
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { margin:0; padding:10px; text-align:center; background:#f0f0f0; font-family:Arial,sans-serif; }
                                .container { max-width:400px; margin:0 auto; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
                                img { max-width:100%; border:2px solid #333; border-radius:8px; margin:10px 0; }
                                .instructions { background:#e3f2fd; padding:10px; border-radius:6px; margin:10px 0; font-size:14px; }
                                .button { background:#4CAF50; color:white; padding:10px 20px; border:none; border-radius:5px; font-size:14px; cursor:pointer; margin:5px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h3>üé´ Ticket #${requirement.ticket_number}</h3>
                                <img src="${dataUrl}" alt="Requirement Ticket" />
                                <div class="instructions">
                                    <strong>üì± To Save:</strong><br>
                                    1. Long-press the image above<br>
                                    2. Select "Save to Photos" or "Download"<br>
                                    3. Check your Gallery app
                                </div>
                                <button class="button" onclick="window.close()">Close</button>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    alert('‚úÖ Ticket opened! Long-press the image and select "Save to Photos"');
                    
                } catch (error) {
                    console.error('Telegram download error:', error);
                    alert('‚ùå Telegram download failed. Please try the Share button instead.');
                }
            };

            // Mobile browser download handler
            const handleMobileDownload = async (canvas, requirement) => {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    // Try direct download first
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `requirement-ticket-${requirement.ticket_number}.png`;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show instructions after a delay
                    setTimeout(() => {
                        alert('üì± If download didn\'t work:\n\n1. Long-press the image in the new tab\n2. Select "Save to Photos"\n3. Check your Gallery app');
                        
                        // Open image in new tab as backup
                        const newWindow = window.open('', '_blank');
                        newWindow.document.write(`
                            <html>
                                <head><title>Save Ticket</title></head>
                                <body style="margin:0;padding:20px;text-align:center;">
                                    <img src="${dataUrl}" style="max-width:100%;border:2px solid #333;" />
                                    <p>Long-press image and select "Save to Photos"</p>
                                </body>
                            </html>
                        `);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Mobile download error:', error);
                    alert('‚ùå Mobile download failed. Please try the Share button instead.');
                }
            };

            // Desktop browser download handler
            const handleDesktopDownload = async (canvas, requirement) => {
                try {
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png', 0.9);
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `requirement-ticket-${requirement.ticket_number}.png`;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 1000);
                    
                    alert('‚úÖ Ticket downloaded successfully! Check your Downloads folder.');
                    
                } catch (error) {
                    console.error('Desktop download error:', error);
                    alert('‚ùå Failed to download ticket. Please try again.');
                }
            };

            // COMPREHENSIVE Mobile Share - Tries EVERY possible method
            const comprehensiveMobileShare = async (canvas, requirement) => {
                const dataUrl = canvas.toDataURL('image/png');
                const filename = `diamond-ticket-${requirement.ticketNumber || Date.now()}.png`;
                
                // Convert dataURL to blob
                const blob = await (async (durl) => {
                    const parts = durl.split(',');
                    const meta = parts[0];
                    const isBase64 = meta.indexOf('base64') !== -1;
                    const mime = meta.split(':')[1].split(';')[0];
                    const raw = isBase64 ? atob(parts[1]) : decodeURIComponent(parts[1]);
                    const u8 = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; ++i) u8[i] = raw.charCodeAt(i);
                    return new Blob([u8], { type: mime });
                })(dataUrl);

                // Detection
                const isTelegram = window.Telegram && window.Telegram.WebApp;
                const isTelegramUA = /Telegram/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                console.log('üîç Share Platform Detection:', { isTelegram, isTelegramUA, isIOS, isAndroid, isMobile });

                // METHOD 1: Telegram WebApp API (if in Telegram)
                if (isTelegram && window.Telegram.WebApp.sendData) {
                    try {
                        console.log('üì± Trying Telegram WebApp share...');
                        const shareText = `Diamond Requirement Ticket #${requirement.ticketNumber || 'N/A'}\n\nShape: ${requirement.shape || 'N/A'}\nSize: ${requirement.sizes_mm || 'N/A'} mm\nColor: ${requirement.color || 'N/A'}\nClarity: ${requirement.clarity || 'N/A'}\nCarats: ${requirement.carats_ct || 'N/A'}\nPrice: ‚Çπ${requirement.price_target_inr || 'N/A'}\nNotes: ${requirement.notes || 'N/A'}`;
                        window.Telegram.WebApp.sendData(shareText);
                        alert('‚úÖ Ticket details sent to Telegram! Check your chat.');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Telegram WebApp share failed:', err);
                    }
                }

                // METHOD 2: Web Share API with Files (Best for Android Chrome)
                if (navigator.canShare && navigator.canShare({ files: [] })) {
                    try {
                        console.log('üì± Trying Web Share API with files...');
                        await navigator.share({
                            files: [new File([blob], filename, { type: 'image/png' })],
                            title: 'Diamond Requirement Ticket',
                            text: `Diamond Ticket #${requirement.ticketNumber || 'N/A'}`
                        });
                        alert('‚úÖ Ticket shared successfully!');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Web Share API failed:', err);
                    }
                }

                // METHOD 3: Web Share API with Text + Data URL (Fallback)
                if (navigator.share) {
                    try {
                        console.log('üì± Trying Web Share API with text...');
                        const shareText = `Diamond Requirement Ticket #${requirement.ticketNumber || 'N/A'}\n\nShape: ${requirement.shape || 'N/A'}\nSize: ${requirement.sizes_mm || 'N/A'} mm\nColor: ${requirement.color || 'N/A'}\nClarity: ${requirement.clarity || 'N/A'}\nCarats: ${requirement.carats_ct || 'N/A'}\nPrice: ‚Çπ${requirement.price_target_inr || 'N/A'}\nNotes: ${requirement.notes || 'N/A'}`;
                        await navigator.share({
                            title: 'Diamond Requirement Ticket',
                            text: shareText,
                            url: dataUrl
                        });
                        alert('‚úÖ Ticket shared successfully!');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Web Share API text failed:', err);
                    }
                }

                // METHOD 4: Clipboard API (if supported)
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        console.log('üì± Trying clipboard...');
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        alert('‚úÖ Image copied to clipboard!\n\nYou can now paste it in any app.');
                        return;
                    } catch (err) {
                        console.warn('‚ùå Clipboard failed:', err);
                    }
                }

                // METHOD 5: Open in New Tab (Universal fallback)
                try {
                    console.log('üì± Opening image in new tab for sharing...');
                    const objectUrl = URL.createObjectURL(blob);
                    const newWindow = window.open(objectUrl, '_blank');
                    
                    if (newWindow) {
                        // Show instructions
                        setTimeout(() => {
                            alert('üì± Image opened in new tab!\n\nTo share:\n‚Ä¢ Long-press the image\n‚Ä¢ Select "Share"\n‚Ä¢ Choose your preferred app\n\nTo save:\n‚Ä¢ Long-press the image\n‚Ä¢ Select "Save to Photos"');
                        }, 1000);
                    } else {
                        throw new Error('Popup blocked');
                    }
                    return;
                } catch (err) {
                    console.warn('‚ùå New tab failed:', err);
                }

                // METHOD 6: Manual Instructions (Last resort)
                console.log('üì± All share methods failed, showing manual instructions...');
                const manualInstructions = `
üì± MOBILE RESTRICTIONS NOTICE:

Due to mobile browser restrictions, the ticket cannot be automatically shared. Here's what you can do:

üì∏ RECOMMENDED: Take a Screenshot & Share
‚Ä¢ Take a screenshot of this ticket
‚Ä¢ Crop to just the ticket area
‚Ä¢ Share the screenshot via any app

üìã ALTERNATIVE: Check My Deals Page
‚Ä¢ Go to "My Deals" page in this app
‚Ä¢ View all your previous diamond requirements
‚Ä¢ Your ticket data is saved there automatically

üåê BROWSER METHOD (if screenshot doesn't work):
‚Ä¢ Long-press on the ticket
‚Ä¢ Select "Share"
‚Ä¢ Choose your preferred app

üìã COPY TEXT METHOD:
‚Ä¢ Copy the ticket details below
‚Ä¢ Paste in any messaging app

üí° TIP: Your requirement is automatically saved to the database, so you can always find it in the "My Deals" page!

Ticket Details:
Shape: ${requirement.shape || 'N/A'}
Size: ${requirement.sizes_mm || 'N/A'} mm
Color: ${requirement.color || 'N/A'}
Clarity: ${requirement.clarity || 'N/A'}
Carats: ${requirement.carats_ct || 'N/A'}
Price: ‚Çπ${requirement.price_target_inr || 'N/A'}
Notes: ${requirement.notes || 'N/A'}
                `;
                
                alert(manualInstructions);
            };

            const shareTicket = async () => {
                try {
                    // Check if mobile and show restrictions notice
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        const mobileNotice = confirm(`
üì± MOBILE NOTICE:

Due to mobile browser restrictions, automatic sharing may not work.

‚úÖ RECOMMENDED: Take a screenshot and share it
‚úÖ ALTERNATIVE: Check "My Deals" page for saved requirements

Click OK to try automatic sharing, or Cancel to take a screenshot instead.
                        `);
                        
                        if (!mobileNotice) {
                            alert('üì∏ Great! Take a screenshot of the ticket and share it via any app. You can also check your saved requirements in the "My Deals" page.');
                            return;
                        }
                    }

                    const ticketElement = document.getElementById('requirement-ticket');
                    if (!ticketElement) {
                        alert('‚ùå Ticket element not found');
                        return;
                    }

                    // Show loading indicator
                    const loadingMsg = document.createElement('div');
                    loadingMsg.innerHTML = 'üîÑ Preparing to share...';
                    loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;color:#fff;padding:20px;border-radius:10px;z-index:9999;';
                    document.body.appendChild(loadingMsg);

                    // Convert to canvas first
                    const canvas = await html2canvas(ticketElement, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        width: ticketElement.offsetWidth,
                        height: ticketElement.offsetHeight,
                        scrollX: 0,
                        scrollY: 0
                    });

                    // Remove loading indicator
                    document.body.removeChild(loadingMsg);

                    // COMPREHENSIVE Mobile Solution - Try EVERY possible method
                    await comprehensiveMobileShare(canvas, savedRequirement);
                    
                } catch (error) {
                    console.error('Error sharing ticket:', error);
                    alert('‚ùå Failed to share ticket. Please try downloading instead.');
                }
            };

            // Telegram WebApp share handler
            const handleTelegramShare = async (canvas, requirement) => {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    // Method 1: Try Telegram WebApp API
                    if (window.Telegram && window.Telegram.WebApp) {
                        try {
                            // Try to share via Telegram WebApp
                            const shareText = `üé´ Diamond Requirement Ticket #${requirement.ticket_number}\n\nDiamond: ${requirement.shape || 'Custom'} shape, ${requirement.carats_ct || 'N/A'} carats, ‚Çπ${requirement.price_target_inr || 'N/A'} budget\n\nMobile: +91 ${requirement.mobile_number}`;
                            
                            // Try to send text first
                            if (window.Telegram.WebApp.sendData) {
                                window.Telegram.WebApp.sendData(shareText);
                                alert('‚úÖ Ticket details sent to Telegram!');
                                return;
                            }
                        } catch (telegramError) {
                            console.log('Telegram API failed, using fallback:', telegramError);
                        }
                    }
                    
                    // Method 2: Open image for manual sharing
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Share Ticket #${requirement.ticket_number}</title>
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { margin:0; padding:10px; text-align:center; background:#f0f0f0; font-family:Arial,sans-serif; }
                                .container { max-width:400px; margin:0 auto; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
                                img { max-width:100%; border:2px solid #333; border-radius:8px; margin:10px 0; }
                                .instructions { background:#e3f2fd; padding:10px; border-radius:6px; margin:10px 0; font-size:14px; }
                                .button { background:#4CAF50; color:white; padding:10px 20px; border:none; border-radius:5px; font-size:14px; cursor:pointer; margin:5px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h3>üé´ Share Ticket #${requirement.ticket_number}</h3>
                                <img src="${dataUrl}" alt="Requirement Ticket" />
                                <div class="instructions">
                                    <strong>üì± To Share:</strong><br>
                                    1. Long-press the image above<br>
                                    2. Select "Share" or "Send to..."<br>
                                    3. Choose WhatsApp, Telegram, etc.
                                </div>
                                <button class="button" onclick="window.close()">Close</button>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    alert('‚úÖ Ticket opened! Long-press the image and select "Share" to send it.');
                    
                } catch (error) {
                    console.error('Telegram share error:', error);
                    alert('‚ùå Telegram share failed. Please try downloading instead.');
                }
            };

            // Mobile browser share handler
            const handleMobileShare = async (canvas, requirement) => {
                try {
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png', 0.9);
                    });
                    
                    const file = new File([blob], `requirement-ticket-${requirement.ticket_number}.png`, { 
                        type: 'image/png' 
                    });

                    const shareData = {
                        title: `Diamond Requirement Ticket #${requirement.ticket_number}`,
                        text: `Diamond requirement: ${requirement.shape || 'Custom'} shape, ${requirement.carats_ct || 'N/A'} carats, ‚Çπ${requirement.price_target_inr || 'N/A'} budget`,
                        files: [file]
                    };

                    // Try Web Share API
                    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                            alert('‚úÖ Ticket image shared successfully!');
                        } catch (shareError) {
                            console.log('Share cancelled:', shareError);
                            alert('‚ÑπÔ∏è Share cancelled. Image opened for manual sharing.');
                            openImageForSharing(canvas, requirement);
                        }
                    } else {
                        // Fallback: Open image for manual sharing
                        openImageForSharing(canvas, requirement);
                    }
                    
                } catch (error) {
                    console.error('Mobile share error:', error);
                    alert('‚ùå Mobile share failed. Please try downloading instead.');
                }
            };

            // Desktop browser share handler
            const handleDesktopShare = async (canvas, requirement) => {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    // Try Web Share API with text only
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `Diamond Requirement Ticket #${requirement.ticket_number}`,
                                text: `Diamond requirement: ${requirement.shape || 'Custom'} shape, ${requirement.carats_ct || 'N/A'} carats, ‚Çπ${requirement.price_target_inr || 'N/A'} budget`,
                                url: window.location.href
                            });
                            alert('‚úÖ Ticket details shared!');
                        } catch (shareError) {
                            console.log('Share cancelled:', shareError);
                            openImageForSharing(canvas, requirement);
                        }
                    } else {
                        // Fallback: Copy to clipboard
                        const shareText = `Diamond Requirement Ticket #${requirement.ticket_number}\n\nDiamond requirement: ${requirement.shape || 'Custom'} shape, ${requirement.carats_ct || 'N/A'} carats, ‚Çπ${requirement.price_target_inr || 'N/A'} budget\n\nView ticket: ${window.location.href}`;
                        
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(shareText);
                            alert('‚úÖ Ticket details copied! You can now paste it in any chat.');
                        } else {
                            openImageForSharing(canvas, requirement);
                        }
                    }
                    
                } catch (error) {
                    console.error('Desktop share error:', error);
                    alert('‚ùå Desktop share failed. Please try downloading instead.');
                }
            };

            // Helper function to open image for manual sharing
            const openImageForSharing = (canvas, requirement) => {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Share Ticket #${requirement.ticket_number}</title>
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { margin:0; padding:20px; text-align:center; background:#f0f0f0; font-family:Arial,sans-serif; }
                                .container { max-width:600px; margin:0 auto; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
                                img { max-width:100%; border:2px solid #333; border-radius:10px; margin:20px 0; }
                                .instructions { background:#e3f2fd; padding:15px; border-radius:8px; margin:20px 0; }
                                .button { background:#4CAF50; color:white; padding:12px 24px; border:none; border-radius:6px; font-size:16px; cursor:pointer; margin:10px; }
                                .button:hover { background:#45a049; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h2>üé´ Diamond Requirement Ticket #${requirement.ticket_number}</h2>
                                <img src="${dataUrl}" alt="Requirement Ticket" />
                                <div class="instructions">
                                    <h3>üì± How to Share:</h3>
                                    <p><strong>On Mobile:</strong> Long-press the image above and select "Share" or "Send to..."</p>
                                    <p><strong>On Desktop:</strong> Right-click the image and select "Copy image" then paste in your chat</p>
                                    <p><strong>Alternative:</strong> Save the image first, then share from your gallery</p>
                                </div>
                                <button class="button" onclick="window.close()">Close</button>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    alert('‚úÖ Ticket image opened! Long-press the image and select "Share" to send it.');
                } catch (error) {
                    console.error('Error opening image for sharing:', error);
                    alert('‚ùå Failed to open image. Please try downloading instead.');
                }
            };

            // Auto-start mobile number recording - keeps recording until 10 digits detected
            const startMobileNumberRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    let allDigits = ''; // Accumulate digits across multiple recordings
                    let checkInterval;
                    
                    const recordAndProcess = async () => {
                        if (allDigits.length >= 10) {
                            // We have 10 digits - stop everything!
                            clearInterval(checkInterval);
                            stream.getTracks().forEach(track => track.stop());
                            setIsRecordingMobile(false);
                            return;
                        }
                        
                        const mediaRecorder = new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };
                        
                        mediaRecorder.onstop = async () => {
                            if (audioChunks.length === 0) return;
                            
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const formData = new FormData();
                            formData.append('file', audioBlob, 'audio.wav');
                            formData.append('model', 'whisper-1');
                            
                            setIsProcessingMobile(true);
                            try {
                                const response = await fetch(OPENAI_API_URL, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                                    },
                                    body: formData,
                                });
                                
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                
                                                const result = await response.json();
                                const transcript = result.text || '';
                                console.log('üé§ Heard:', transcript);
                                
                                // Convert word numbers to digits (e.g., "nine eight seven" -> "987")
                                const numberWords = {
                                    'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4',
                                    'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9',
                                    'oh': '0', 'to': '2', 'for': '4', 'tree': '3', 'too': '2'
                                };
                                
                                let convertedText = transcript.toLowerCase();
                                Object.keys(numberWords).forEach(word => {
                                    convertedText = convertedText.replace(new RegExp(word, 'g'), numberWords[word]);
                                });
                                
                                // Extract all digits
                                const newDigits = convertedText.replace(/\D/g, '');
                                
                                if (newDigits.length > 0) {
                                    allDigits += newDigits;
                                    console.log('üì± New digits:', newDigits, '| Total so far:', allDigits);
                                    const progress = allDigits.split('').join(' ');
                                    setMobileTranscript(`Got ${allDigits.length}/10 digits: ${progress}`);
                                } else {
                                    console.log('‚ö†Ô∏è No digits detected in:', transcript);
                                    setMobileTranscript(`Listening... (${allDigits.length}/10 digits so far)`);
                                }
                                
                                // Check if we have 10 digits
                                if (allDigits.length >= 10) {
                                    const validNumber = allDigits.substring(0, 10); // Take first 10
                                    setMobileNumber(validNumber);
                                    console.log('‚úÖ Mobile number complete:', validNumber);
                                    
                                    // Save to cookie for 30 days
                                    document.cookie = `diamond_mobile=${validNumber}; max-age=${30*24*60*60}; path=/`;
                                    console.log('üç™ Mobile number saved to cookie');
                                    
                                    clearInterval(checkInterval);
                                    stream.getTracks().forEach(track => track.stop());
                                    setIsRecordingMobile(false);
                                    setMobileTranscript(`‚úÖ Complete: ${validNumber}`);
                                } else {
                                    console.log(`‚è≥ Need ${10 - allDigits.length} more digits...`);
                                }
                            } catch (error) {
                                console.error('Mobile transcription error:', error);
                                setMobileTranscript('Error - please speak clearly');
                            } finally {
                                setIsProcessingMobile(false);
                            }
                        };
                        
                        mediaRecorder.start();
                        setIsRecordingMobile(true);
                        
                        // Record for 2 seconds then process
                        setTimeout(() => {
                            if (mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                            }
                        }, 2000);
                    };
                    
                    // Start first recording
                    await recordAndProcess();
                    
                    // Continue recording every 2.5 seconds until we have 10 digits
                    checkInterval = setInterval(async () => {
                        if (allDigits.length < 10) {
                            await recordAndProcess();
                        } else {
                            clearInterval(checkInterval);
                        }
                    }, 2500);
                    
                    // Safety: Stop after 30 seconds max
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecordingMobile(false);
                        
                        if (allDigits.length > 0 && allDigits.length < 10) {
                            setMobileTranscript(`Only got ${allDigits.length} digits. Please type the rest or try again.`);
                        }
                    }, 30000);
                } catch (error) {
                    console.error('Mobile recording error:', error);
                    setMobileTranscript('Microphone access denied - please type manually');
                    setIsRecordingMobile(false);
                }
            };

            // Auto-start mobile recording when popup opens + load from cookie
            useEffect(() => {
                if (showMobilePopup) {
                    // Check if mobile number exists in cookie
                    const cookies = document.cookie.split(';');
                    const mobileCookie = cookies.find(c => c.trim().startsWith('diamond_mobile='));
                    
                    if (mobileCookie) {
                        const savedNumber = mobileCookie.split('=')[1];
                        if (savedNumber && savedNumber.length === 10) {
                            setMobileNumber(savedNumber);
                            setMobileTranscript(`Found saved number: ${savedNumber}`);
                            console.log('üç™ Loaded mobile number from cookie:', savedNumber);
                            return; // Don't start recording if number exists
                        }
                    }
                    
                    // No saved number - start voice recording
                    const timer = setTimeout(() => {
                        startMobileNumberRecording();
                    }, 500); // Small delay to let popup render
                    return () => clearTimeout(timer);
                }
            }, [showMobilePopup]);

            // Voice functionality functions
            const checkConnectivity = async () => {
                try {
                    const endpoints = [
                        'https://www.google.com/favicon.ico',
                        'https://www.googleapis.com',
                        'https://speech.googleapis.com'
                    ];
                    for (const endpoint of endpoints) {
                        try {
                            const response = await fetch(endpoint, {
                                method: 'HEAD',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                timeout: 5000
                            });
                            return true;
                        } catch (error) {
                            continue;
                        }
                    }
                    const response = await fetch('https://httpbin.org/status/200', {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            };

            const speakAsync = (text, { interrupt = false, rate = 1.4 } = {}) => {
                return new Promise((resolve) => {
                    if (!('speechSynthesis' in window)) return resolve();
                    if (interrupt) window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = rate;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve();
                    window.speechSynthesis.speak(utterance);
                });
            };

            const parseWithAI = async (transcript) => {
                try {
                    console.log('ü§ñ Starting AI parsing for:', transcript);
                    
                    const systemPrompt = `You are a diamond expert. Extract diamond specifications from user input. 
                    IMPORTANT: If the user speaks in ANY language other than English, FIRST translate to English, THEN extract specifications.
                    Return ONLY a JSON object with these exact keys: {"shape": "", "sizes_mm": "", "color": "", "clarity": "", "carats_ct": "", "price_target_inr": ""}
                    
                    Key Rules:
                    - VV2, VVS2, VV1, VVS1 are valid clarity grades
                    - Extract numbers as carats (21 carats = "21")
                    - Round shape = "ROUND"
                    - Be precise with clarity grades (VV2, VVS1, VS2, etc.)
                    
                    Examples:
                    - "round shape and VV2 clarity and 21 carats" ‚Üí {"shape": "ROUND", "sizes_mm": "", "color": "", "clarity": "VV2", "carats_ct": "21", "price_target_inr": ""}
                    - "I want round diamond 1 carat white color VS clarity 50000 rupees" ‚Üí {"shape": "ROUND", "sizes_mm": "", "color": "D", "clarity": "VS", "carats_ct": "1.0", "price_target_inr": "50000"}
                    
                    User said: "${transcript}"`;

                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt }] }]
                        })
                    });

                    if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);
                    const data = await response.json();
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    
                    console.log('ü§ñ AI Raw Response:', aiResponse);
                    
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        console.log('ü§ñ Parsed JSON:', parsed);
                        return parsed;
                    }
                    return {};
                } catch (error) {
                    console.error('AI parsing error:', error);
                    return {};
                }
            };

            // Fallback parsing function for when AI fails
            const parseVoiceInputFallback = (transcript) => {
                const result = {};
                const lower = transcript.toLowerCase();
                
                console.log('üîÑ Fallback parsing input:', transcript);
                
                // IMPROVED: Shape parsing - exact 14 standard diamond shapes + Custom with fuzzy matching + Hindi support
                const standardDiamondShapes = ['Round', 'Princess', 'Cushion', 'Emerald', 'Oval', 'Pear', 'Marquise', 'Heart', 'Radiant', 'Asscher', 'Baguette', 'Trillion', 'Old European', 'Rose-cut', 'Custom'];
                
                // Function to find closest shape match
                const findClosestShape = (input) => {
                    const lowerInput = input.toLowerCase();
                    
                    // Hindi shape words
                    if (lowerInput.includes('aakaar') || lowerInput.includes('aakar') || lowerInput.includes('aakar')) {
                        // Extract shape after "aakaar"
                        const shapeAfterAakaar = input.match(/aakaar\s+(\w+)|aakar\s+(\w+)|aakar\s+(\w+)/i);
                        if (shapeAfterAakaar) {
                            const shapeWord = (shapeAfterAakaar[1] || shapeAfterAakaar[2] || shapeAfterAakaar[3]).toLowerCase();
                            // Map Hindi shape words to English
                            const hindiShapeMap = {
                                'round': 'Round',
                                'gol': 'Round',
                                'princess': 'Princess',
                                'cushion': 'Cushion',
                                'emerald': 'Emerald',
                                'oval': 'Oval',
                                'pear': 'Pear',
                                'marquise': 'Marquise',
                                'heart': 'Heart',
                                'radiant': 'Radiant',
                                'asscher': 'Asscher',
                                'baguette': 'Baguette',
                                'trillion': 'Trillion',
                                'custom': 'Custom',
                                'khud': 'Custom',
                                'banaya': 'Custom'
                            };
                            if (hindiShapeMap[shapeWord]) {
                                return hindiShapeMap[shapeWord];
                            }
                        }
                        return 'Custom'; // Default if shape not specified
                    }
                    
                    // Check for "custom" first (exact match priority)
                    if (lowerInput.includes('custom')) {
                        return 'Custom';
                    }
                    
                    // Direct matches for standard shapes
                    for (const shape of standardDiamondShapes) {
                        if (lowerInput.includes(shape.toLowerCase())) {
                            return shape;
                        }
                    }
                    
                    // Fuzzy matching for common mistakes and variations
                    const fuzzyMatches = {
                        // Round variations
                        'round': 'Round',
                        'rounds': 'Round',
                        'round shape': 'Round',
                        'round diamond': 'Round',
                        
                        // Princess variations
                        'princess': 'Princess',
                        'princess cut': 'Princess',
                        'princess shape': 'Princess',
                        'princess diamond': 'Princess',
                        
                        // Cushion variations
                        'cushion': 'Cushion',
                        'cushion cut': 'Cushion',
                        'cushion shape': 'Cushion',
                        'cushion diamond': 'Cushion',
                        
                        // Emerald variations
                        'emerald': 'Emerald',
                        'emerald cut': 'Emerald',
                        'emerald shape': 'Emerald',
                        'emerald diamond': 'Emerald',
                        
                        // Oval variations
                        'oval': 'Oval',
                        'ovals': 'Oval',
                        'oval shape': 'Oval',
                        'oval diamond': 'Oval',
                        
                        // Pear variations
                        'pear': 'Pear',
                        'pear shape': 'Pear',
                        'pear diamond': 'Pear',
                        'teardrop': 'Pear',
                        
                        // Marquise variations
                        'marquise': 'Marquise',
                        'marquise cut': 'Marquise',
                        'marquise shape': 'Marquise',
                        'marquise diamond': 'Marquise',
                        
                        // Heart variations
                        'heart': 'Heart',
                        'heart shape': 'Heart',
                        'heart diamond': 'Heart',
                        'hearts': 'Heart',
                        
                        // Radiant variations
                        'radiant': 'Radiant',
                        'radiant cut': 'Radiant',
                        'radiant shape': 'Radiant',
                        'radiant diamond': 'Radiant',
                        
                        // Asscher variations
                        'asscher': 'Asscher',
                        'asscher cut': 'Asscher',
                        'asscher shape': 'Asscher',
                        'asscher diamond': 'Asscher',
                        
                        // Baguette variations
                        'baguette': 'Baguette',
                        'baguette cut': 'Baguette',
                        'baguette shape': 'Baguette',
                        'baguette diamond': 'Baguette',
                        
                        // Trillion variations
                        'trillion': 'Trillion',
                        'trillion cut': 'Trillion',
                        'trillion shape': 'Trillion',
                        'trillion diamond': 'Trillion',
                        'trilliant': 'Trillion',
                        
                        // Old European variations
                        'old european': 'Old European',
                        'old european cut': 'Old European',
                        'old european shape': 'Old European',
                        'old european diamond': 'Old European',
                        'european': 'Old European',
                        'european cut': 'Old European',
                        
                        // Rose-cut variations
                        'rose cut': 'Rose-cut',
                        'rose-cut': 'Rose-cut',
                        'rose cut diamond': 'Rose-cut',
                        'rose shape': 'Rose-cut',
                        'rosecut': 'Rose-cut',
                        
                        // Custom variations
                        'custom': 'Custom',
                        'custom shape': 'Custom',
                        'custom cut': 'Custom',
                        'custom diamond': 'Custom',
                        'custom made': 'Custom',
                        'customized': 'Custom',
                        
                        // Common mishearings
                        'rounds': 'Round',
                        'rounds shape': 'Round',
                        'round diamond': 'Round',
                        'round cut': 'Round',
                        'rounds cut': 'Round',
                        'rounds diamond': 'Round'
                    };
                    
                    // Check for fuzzy matches
                    for (const [mistake, correct] of Object.entries(fuzzyMatches)) {
                        if (lowerInput.includes(mistake)) {
                            console.log(`üíé Shape fuzzy match: "${mistake}" ‚Üí "${correct}"`);
                            return correct;
                        }
                    }
                    
                    // Partial matching for common words
                    if (lowerInput.includes('custom')) return 'Custom'; // Check custom first
                    if (lowerInput.includes('round')) return 'Round';
                    if (lowerInput.includes('princess')) return 'Princess';
                    if (lowerInput.includes('cushion')) return 'Cushion';
                    if (lowerInput.includes('emerald')) return 'Emerald';
                    if (lowerInput.includes('oval')) return 'Oval';
                    if (lowerInput.includes('pear')) return 'Pear';
                    if (lowerInput.includes('marquise')) return 'Marquise';
                    if (lowerInput.includes('heart')) return 'Heart';
                    if (lowerInput.includes('radiant')) return 'Radiant';
                    if (lowerInput.includes('asscher')) return 'Asscher';
                    if (lowerInput.includes('baguette')) return 'Baguette';
                    if (lowerInput.includes('trillion')) return 'Trillion';
                    if (lowerInput.includes('european')) return 'Old European';
                    if (lowerInput.includes('rose')) return 'Rose-cut';
                    
                    return null;
                };
                
                // Find shape using fuzzy matching
                const matchedShape = findClosestShape(transcript);
                if (matchedShape) {
                    result.shape = matchedShape;
                    console.log(`üíé Shape found: "${matchedShape}"`);
                }
                
                // IMPROVED: Color parsing - store actual color names + Hindi support
                const colorNames = ['white', 'yellow', 'orange', 'pink', 'blue', 'green', 'red', 'purple', 'black', 'brown', 'gray', 'grey'];
                let foundColor = null;
                
                // Hindi color words
                if (lower.includes('rang') || lower.includes('rang meela')) {
                    // Extract color after "rang"
                    const colorAfterRang = transcript.match(/rang\s+(\w+)|rang\s+meela/i);
                    if (colorAfterRang) {
                        const colorWord = colorAfterRang[1] ? colorAfterRang[1].toLowerCase() : 'meela';
                        // Map Hindi color words to English
                        const hindiColorMap = {
                            'meela': 'Blue',
                            'neela': 'Blue',
                            'safed': 'White',
                            'peela': 'Yellow',
                            'hara': 'Green',
                            'lal': 'Red',
                            'gulabi': 'Pink',
                            'narangi': 'Orange',
                            'kala': 'Black',
                            'bhura': 'Brown',
                            'dhundhla': 'Gray'
                        };
                        if (hindiColorMap[colorWord]) {
                            foundColor = hindiColorMap[colorWord];
                        } else {
                            foundColor = 'Blue'; // Default for "meela"
                        }
                    }
                }
                
                // English color parsing
                if (!foundColor) {
                    for (const colorName of colorNames) {
                        if (lower.includes(colorName + ' color') || lower.includes(colorName + ' diamond') || 
                            (lower.includes(colorName) && !lower.includes(colorName + ' shape'))) {
                            foundColor = colorName.charAt(0).toUpperCase() + colorName.slice(1);
                            break;
                        }
                    }
                }
                
                if (foundColor) {
                    result.color = foundColor;
                } else {
                    // Fallback to diamond grade letters (D-Z)
                    const colorMatch = transcript.match(/([D-Z])\s*(?:color)?/i);
                    if (colorMatch) result.color = colorMatch[1].toUpperCase();
                }
                
                // IMPROVED: Carats parsing - multiple patterns including mm confusion and "caret is" pattern
                const caratPatterns = [
                    /(\d+(?:\.\d+)?)\s*carats?/i,
                    /carats?\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*ct/i,
                    /ct\s*(\d+(?:\.\d+)?)/i,
                    /carats?\s*is\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*carats?\s*is/i,
                    /carrot\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*carrot/i,
                    /carrot\s*is\s*(\d+(?:\.\d+)?)/i,
                    /carrot\s*and\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*carrot\s*and/i,
                    /carrot\s*have\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*carrot\s*have/i,
                    /caret\s*is\s*(\d+(?:\.\d+)?)/i,  // NEW: "caret is 2.75"
                    /caret\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*caret/i,
                    /caret\s*and\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*caret\s*and/i,
                    /caret\s*have\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*caret\s*have/i,
                    /karat\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*karat/i,
                    /karat\s*is\s*(\d+(?:\.\d+)?)/i,  // NEW: "karat is"
                    /karats?\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*karats?/i,
                    /carrot\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*carrot/i,
                    /carats?\s*were\s*(\d+(?:\.\d+)?)/i,
                    /carats?\s*(\d+(?:\.\d+)?)\s*were/i,
                    /(\d+(?:\.\d+)?)\s*carats?\s*were/i,
                    /were\s*(\d+(?:\.\d+)?)\s*carats/i,
                    /carats?\s*(\d+(?:\.\d+)?)\s*carats/i,
                    /(\d+(?:\.\d+)?)\s*carats?\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*mm\s*in\s*carats/i,
                    /in\s*carats\s*(\d+(?:\.\d+)?)\s*mm/i,
                    /(\d+(?:\.\d+)?)\s*mm\s*carats/i,
                    /carats\s*(\d+(?:\.\d+)?)\s*mm/i
                ];
                
                for (const pattern of caratPatterns) {
                    const caratMatch = transcript.match(pattern);
                    if (caratMatch) {
                        result.carats_ct = caratMatch[1];
                        console.log(`üíé Carats found: ${caratMatch[1]}`);
                        break;
                    }
                }
                
                // IMPROVED: Clarity parsing - exact 12 standard diamond clarity grades with fuzzy matching + Hindi support
                const standardClarityGrades = ['FL', 'IF', 'VVS1', 'VVS2', 'VS1', 'VS2', 'SI1', 'SI2', 'I1', 'I2', 'I3', 'BS'];
                
                // Function to find closest clarity grade match
                const findClosestClarity = (input) => {
                    const upperInput = input.toUpperCase();
                    
                    // Hindi clarity words
                    if (upperInput.includes('SPASHTATA') || upperInput.includes('SPASHTA') || upperInput.includes('SPASTA')) {
                        // Extract clarity after "spashtata"
                        const clarityAfterSpashtata = input.match(/spashtata\s+(\w+)|spashta\s+(\w+)|spasta\s+(\w+)/i);
                        if (clarityAfterSpashtata) {
                            const clarityWord = (clarityAfterSpashtata[1] || clarityAfterSpashtata[2] || clarityAfterSpashtata[3]).toUpperCase();
                            // Map Hindi clarity words to English grades
                            const hindiClarityMap = {
                                'YADI': 'IF',
                                'IF': 'IF',
                                'FL': 'FL',
                                'VVS1': 'VVS1',
                                'VVS2': 'VVS2',
                                'VS1': 'VS1',
                                'VS2': 'VS2',
                                'SI1': 'SI1',
                                'SI2': 'SI2',
                                'I1': 'I1',
                                'I2': 'I2',
                                'I3': 'I3'
                            };
                            if (hindiClarityMap[clarityWord]) {
                                return hindiClarityMap[clarityWord];
                            }
                        }
                        return 'IF'; // Default if clarity not specified
                    }
                    
                    // Direct matches first
                    for (const grade of standardClarityGrades) {
                        if (upperInput.includes(grade)) {
                            return grade;
                        }
                    }
                    
                    // Fuzzy matching for common mistakes
                    const fuzzyMatches = {
                        'PVSVS': 'VVS1',
                        'PVS': 'VS1', 
                        'PVVS': 'VVS1',
                        'VV': 'VVS1',
                        'VVS': 'VVS1',
                        'VS': 'VS1',
                        'SI': 'SI1',
                        'I': 'I1',
                        'FL': 'FL',
                        'IF': 'IF',
                        'BS': 'BS',  // NEW: BS clarity grade
                        'VB1': 'VVS1',
                        'VB2': 'VVS2',
                        'VV1': 'VVS1',
                        'VV2': 'VVS2',
                        'VVVS': 'VVS1',
                        'VVVS1': 'VVS1',
                        'VVVS2': 'VVS2',
                        'VVSVS': 'VVS1',
                        'VSVS': 'VS1',
                        'SISI': 'SI1',
                        'SISI1': 'SI1',
                        'SISI2': 'SI2'
                    };
                    
                    // Check for fuzzy matches
                    for (const [mistake, correct] of Object.entries(fuzzyMatches)) {
                        if (upperInput.includes(mistake)) {
                            console.log(`üîç Clarity fuzzy match: "${mistake}" ‚Üí "${correct}"`);
                            return correct;
                        }
                    }
                    
                    // Partial matching for numbers
                    if (upperInput.includes('VVS') && (upperInput.includes('1') || upperInput.includes('ONE'))) return 'VVS1';
                    if (upperInput.includes('VVS') && (upperInput.includes('2') || upperInput.includes('TWO'))) return 'VVS2';
                    if (upperInput.includes('VS') && (upperInput.includes('1') || upperInput.includes('ONE'))) return 'VS1';
                    if (upperInput.includes('VS') && (upperInput.includes('2') || upperInput.includes('TWO'))) return 'VS2';
                    if (upperInput.includes('SI') && (upperInput.includes('1') || upperInput.includes('ONE'))) return 'SI1';
                    if (upperInput.includes('SI') && (upperInput.includes('2') || upperInput.includes('TWO'))) return 'SI2';
                    if (upperInput.includes('I') && (upperInput.includes('1') || upperInput.includes('ONE'))) return 'I1';
                    if (upperInput.includes('I') && (upperInput.includes('2') || upperInput.includes('TWO'))) return 'I2';
                    if (upperInput.includes('I') && (upperInput.includes('3') || upperInput.includes('THREE'))) return 'I3';
                    
                    return null;
                };
                
                const clarityPatterns = [
                    /(VB[12]|VV[12]|VVS[12]|VS[12]|SI[12]|IF|FL|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|I[123])/i,
                    /clarity\s*(VB[12]|VV[12]|VVS[12]|VS[12]|SI[12]|IF|FL|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|I[123])/i,
                    /(VB[12]|VV[12]|VVS[12]|VS[12]|SI[12]|IF|FL|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|I[123])\s*clarity/i,
                    /clarity\s*is\s*(VB[12]|VV[12]|VVS[12]|VS[12]|SI[12]|IF|FL|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|I[123])/i,
                    /(VB[12]|VV[12]|VVS[12]|VS[12]|SI[12]|IF|FL|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|I[123])\s*is\s*clarity/i
                ];
                
                for (const pattern of clarityPatterns) {
                    const clarityMatch = transcript.match(pattern);
                    if (clarityMatch) {
                        const inputClarity = clarityMatch[1];
                        const matchedClarity = findClosestClarity(inputClarity);
                        
                        if (matchedClarity) {
                            result.clarity = matchedClarity;
                            console.log(`üîç Clarity found: "${inputClarity}" ‚Üí "${matchedClarity}"`);
                            break;
                        }
                    }
                }
                
                // Fallback: Try to find any clarity-like word in the transcript
                if (!result.clarity) {
                    const clarityWords = transcript.match(/\b(FL|IF|VVS|VS|SI|I|PVSVS|PVS|PVVS|VVVS|VSVS|SISI|VB|VV)\b/gi);
                    if (clarityWords) {
                        for (const word of clarityWords) {
                            const matchedClarity = findClosestClarity(word);
                            if (matchedClarity) {
                                result.clarity = matchedClarity;
                                console.log(`üîç Clarity fallback found: "${word}" ‚Üí "${matchedClarity}"`);
                                break;
                            }
                        }
                    }
                }
                
                // IMPROVED: Size parsing - multiple patterns + Hindi support
                const sizePatterns = [
                    /(\d+(?:\.\d+)?)\s*(?:mm|millimeter)/i,
                    /size\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*size/i,
                    /(\d+(?:\.\d+)?)\s*(?:mm|millimeter)?\s*(?:size)?/i,
                    // Hindi patterns
                    /aakaar\s*(\d+(?:\.\d+)?)/i,
                    /aakar\s*(\d+(?:\.\d+)?)/i,
                    /aakar\s*(\d+(?:\.\d+)?)/i,
                    /(\d+(?:\.\d+)?)\s*aakaar/i,
                    /(\d+(?:\.\d+)?)\s*aakar/i,
                    /(\d+(?:\.\d+)?)\s*aakar/i
                ];
                
                for (const pattern of sizePatterns) {
                    const sizeMatch = transcript.match(pattern);
                    if (sizeMatch) {
                        result.sizes_mm = sizeMatch[1];
                        console.log(`üìè Size found: ${sizeMatch[1]} mm`);
                        break;
                    }
                }
                
                // IMPROVED: Price parsing - multiple patterns including "best target" and 10000+ rule
                const pricePatterns = [
                    /(\d+(?:\.\d+)?)\s*(?:lakhs?|lacs?)/i,
                    /(\d+(?:,\d+)*)\s*(?:rupees?|inr|rs)/i,
                    /base\s*target\s*(\d+(?:,\d+)*)/i,
                    /target\s*(\d+(?:,\d+)*)/i,
                    /price\s*(\d+(?:,\d+)*)/i,
                    /(\d+(?:,\d+)*)\s*price/i,
                    /budget\s*(\d+(?:,\d+)*)/i,
                    /(\d+(?:,\d+)*)\s*budget/i,
                    /base\s*target\s*is\s*(\d+(?:,\d+)*)/i,
                    /(\d+(?:,\d+)*)\s*base\s*target/i,
                    /best\s*target\s*(\d+(?:,\d+)*)/i,
                    /best\s*target\s*was\s*(\d+(?:,\d+)*)/i,
                    /(\d+(?:,\d+)*)\s*best\s*target/i,
                    /target\s*was\s*(\d+(?:,\d+)*)/i,
                    /(\d+(?:,\d+)*)\s*target\s*was/i,
                    /in\s*target\s*it\s*will\s*be\s*(\d+(?:,\d+)*)/i,
                    /target\s*it\s*will\s*be\s*(\d+(?:,\d+)*)/i,
                    /it\s*will\s*be\s*(\d+(?:,\d+)*)/i
                ];
                
                for (const pattern of pricePatterns) {
                    const priceMatch = transcript.match(pattern);
                    if (priceMatch) {
                        let price = priceMatch[1].replace(/,/g, '');
                        
                        // Handle lakhs conversion
                        if (pattern.source.includes('lakhs?|lacs?')) {
                            const lakhs = parseFloat(price);
                            price = (lakhs * 100000).toString();
                            console.log(`üí∞ Price: ${priceMatch[1]} lakhs = ${price} INR`);
                        } else {
                            console.log(`üí∞ Price found: ${price} INR`);
                        }
                        
                        result.price_target_inr = price;
                        break;
                    }
                }
                
                // SPECIAL RULE: If no price found and there's a number > 10000, treat it as price
                if (!result.price_target_inr) {
                    const allNumbers = transcript.match(/(\d+(?:,\d+)*)/g);
                    if (allNumbers) {
                        for (const numStr of allNumbers) {
                            const num = parseInt(numStr.replace(/,/g, ''));
                            if (num >= 10000) {
                                result.price_target_inr = num.toString();
                                console.log(`üí∞ Price found by 10000+ rule: ${num} INR`);
                                break;
                            }
                        }
                    }
                }
                
                // IMPROVED: Notes parsing - multiple patterns including delivery time patterns + Hindi support
                const notesPatterns = [
                    // English patterns
                    /(?:in notes?|note[sd]?|requirements?|special|needs? to be)\s+(.+?)(?:\.|$)/i,
                    /nodes?\s+(.+?)(?:\.|$)/i,
                    /notes?\s+(.+?)(?:\.|$)/i,
                    /(?:quick delivery|fast delivery|urgent|priority)\s*(.+?)(?:\.|$)/i,
                    /nodes?\s*,\s*i\s*(?:maxed|max|maximum)\s*(.+?)(?:\.|$)/i,
                    /i\s*(?:maxed|max|maximum)\s*(.+?)(?:\.|$)/i,
                    /maxed\s*(.+?)(?:\.|$)/i,
                    /maximum\s*(.+?)(?:\.|$)/i,
                    /quickdwellvary/i,
                    /quick\s*dwell\s*vary/i,
                    /quick\s*dwellvary/i,
                    /quick\s*dualary/i,
                    /quick\s*delivery/i,
                    /i\s*mentioned\s*a\s*(.+?)(?:\.|$)/i,
                    /mentioned\s*a\s*(.+?)(?:\.|$)/i,
                    /(\d+)\s*days?\s*delivery/i,
                    /(\d+)\s*days?\s*delivery\s*in\s*notes/i,
                    /delivery\s*(\d+)\s*days/i,
                    /(\d+)\s*days?\s*delivery\s*in\s*notes/i,
                    /in\s*notes\s*(\d+)\s*days?\s*delivery/i,
                    /make\s*it\s*deliver\s*(.+?)(?:\.|$)/i,
                    /make\s*it\s*(.+?)(?:\.|$)/i,
                    /deliver\s*(.+?)(?:\.|$)/i,
                    /deliver\s*quickly/i,
                    /make\s*it\s*deliver\s*quickly/i,
                    // Hindi patterns
                    /notes?\s+(.+?)(?:\s+aakaar|\s+rang|\s+spashtata|\s+carat|\s+price|\s*$)/i,
                    /note\s+(.+?)(?:\s+aakaar|\s+rang|\s+spashtata|\s+carat|\s+price|\s*$)/i,
                    /happy\s+(.+)/i,  // For "Happy Diwali" pattern
                    /diwali/i,  // Direct Diwali mention
                    /festival/i,  // Festival mentions
                    /wishes/i,  // Wishes mentions
                    /shubh\s+(.+)/i,  // Shubh (auspicious) mentions
                    /mubarak\s+(.+)/i,  // Mubarak (blessed) mentions
                    /badhai\s+(.+)/i,  // Badhai (congratulations) mentions
                    /aashirwad\s+(.+)/i,  // Aashirwad (blessings) mentions
                    /(?:jaldi|fast|quick)\s+(?:delivery|pahunchana)/i,  // Quick delivery in Hindi
                    /(?:urgent|jaldi)\s+(.+)/i  // Urgent in Hindi
                ];
                
                for (const pattern of notesPatterns) {
                    const notesMatch = transcript.match(pattern);
                    if (notesMatch) {
                        let notes = notesMatch[1] ? notesMatch[1].trim() : notesMatch[0].trim();
                        
                        // Clean up common phrases and mishearings
                        if (notes.toLowerCase().includes('quickdwellvary')) {
                            notes = 'QuickDwellVary';
                        } else if (notes.toLowerCase().includes('quick dwell vary')) {
                            notes = 'QuickDwellVary';
                        } else if (notes.toLowerCase().includes('quick dwellvary')) {
                            notes = 'QuickDwellVary';
                        } else if (notes.toLowerCase().includes('quick dualary')) {
                            notes = 'Quick delivery';
                        } else if (notes.toLowerCase().includes('quick delivery')) {
                            notes = 'Quick delivery';
                        } else if (notes.match(/\d+\s*days?\s*delivery/i)) {
                            // Handle delivery time patterns like "2 days delivery"
                            const deliveryMatch = notes.match(/(\d+)\s*days?\s*delivery/i);
                            if (deliveryMatch) {
                                notes = `${deliveryMatch[1]} days delivery`;
                            }
                        } else if (notes.toLowerCase().includes('deliver quickly')) {
                            notes = 'Deliver quickly';
                        } else if (notes.toLowerCase().includes('make it deliver quickly')) {
                            notes = 'Make it deliver quickly';
                        }
                        
                        result.notes = notes;
                        console.log(`üìù Notes extracted: "${result.notes}"`);
                        break;
                    }
                }
                
                // Special handling for "quick delivery" variations
                if (lower.includes('quick delivery') || lower.includes('fast delivery')) {
                    result.notes = (result.notes || '') + ' Quick delivery required';
                }
                
                // Special handling for QuickDwellVary
                if (lower.includes('quickdwellvary') || lower.includes('quick dwell vary') || lower.includes('quick dwellvary')) {
                    result.notes = 'QuickDwellVary';
                }
                
                // Special handling for "quick dualary" ‚Üí "quick delivery"
                if (lower.includes('quick dualary')) {
                    result.notes = 'Quick delivery';
                }
                
                // Special handling for delivery time patterns
                const deliveryTimeMatch = transcript.match(/(\d+)\s*days?\s*delivery/i);
                if (deliveryTimeMatch) {
                    result.notes = `${deliveryTimeMatch[1]} days delivery`;
                    console.log(`üìù Delivery time found: ${result.notes}`);
                }
                
                // Special handling for "make it deliver quickly"
                if (lower.includes('make it deliver quickly')) {
                    result.notes = 'Make it deliver quickly';
                    console.log(`üìù Delivery instruction found: ${result.notes}`);
                } else if (lower.includes('deliver quickly')) {
                    result.notes = 'Deliver quickly';
                    console.log(`üìù Delivery instruction found: ${result.notes}`);
                }
                
                console.log('üîÑ Fallback parsing output:', result);
                return result;
            };

            const processAudioWithOpenAI = async (audioBlob) => {
                try {
                    setIsProcessing(true);
                    setError('');
                    
                    // Add timeout to prevent infinite processing
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Processing timeout - please try again')), 10000)
                    );
                    
                    const formData = new FormData();
                    
                    // Convert audio blob to proper format for Whisper API
                    // Whisper API prefers mp3, wav, or m4a formats
                    let audioFile;
                    if (audioBlob.type === 'audio/webm') {
                        // Convert webm to wav for better compatibility
                        audioFile = new File([audioBlob], 'audio.wav', { type: 'audio/wav' });
                    } else {
                        audioFile = new File([audioBlob], 'audio.wav', { type: 'audio/wav' });
                    }
                    
                    formData.append('file', audioFile);
                    formData.append('model', 'whisper-1');
                    formData.append('language', 'en');
                    formData.append('response_format', 'json');

                    console.log('üé§ Sending audio to OpenAI:', {
                        size: audioFile.size,
                        type: audioFile.type,
                        name: audioFile.name
                    });

                    const fetchPromise = fetch(OPENAI_API_URL, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${OPENAI_API_KEY}`,
                            // Don't set Content-Type, let browser set it with boundary
                        },
                        body: formData
                    });

                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('OpenAI API Error Response:', errorText);
                        throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ OpenAI Response:', data);
                    return data.text || '';
                } catch (error) {
                    console.error('OpenAI processing error:', error);
                    throw error;
                } finally {
                    setIsProcessing(false);
                }
            };

            const startAudioRecording = async () => {
                try {
                    // Try with optimal constraints first, fallback to basic if needed
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({
                            audio: { 
                                echoCancellation: true, 
                                noiseSuppression: true, 
                                autoGainControl: true,
                                sampleRate: 44100 
                            }
                        });
                        console.log('üé§ Microphone accessed with optimal settings');
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Optimal audio constraints failed, trying basic...', err);
                        // Fallback to basic constraints for compatibility
                        stream = await navigator.mediaDevices.getUserMedia({
                            audio: true
                        });
                        console.log('üé§ Microphone accessed with basic settings');
                    }
                    
                    // Try to use a more compatible format for Whisper API
                    let mimeType = 'audio/webm;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/webm';
                    }
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                    }
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/ogg;codecs=opus';
                    }
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = ''; // Use default
                    }
                    
                    console.log('üé§ Using audio format:', mimeType || 'default');
                    
                    const mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
                    mediaRecorderRef.current = mediaRecorder;
                    audioChunksRef.current = [];
                    lastVoiceTsRef.current = performance.now();

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunksRef.current.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                        try {
                            const transcript = await processAudioWithOpenAI(audioBlob);
                            setVoiceTranscript(transcript);
                            
                            console.log('üé§ Transcript received:', transcript);
                            console.log('üé§ Auto voice mode:', autoVoiceMode);
                            
                            // ALWAYS try to parse, not just in auto voice mode
                            if (transcript && transcript.length > 0) {
                                console.log('ü§ñ Starting to parse transcript:', transcript);
                                
                                // First try fallback (faster)
                                const fallbackParsed = parseVoiceInputFallback(transcript);
                                console.log('üîÑ Fallback parsing result:', fallbackParsed);
                                
                                if (Object.keys(fallbackParsed).length > 0) {
                                    setFormState(prev => {
                                        const updated = { ...prev, ...fallbackParsed };
                                        console.log('üìù Form state updated with fallback:', updated);
                                        return updated;
                                    });
                                }
                                
                                // AI parsing disabled - fallback is working perfectly!
                                console.log('‚úÖ Using fallback parsing only (AI disabled to avoid errors)');
                                
                                setAutoVoiceMode(false);
                            }
                        } catch (error) {
                            console.error('Audio processing error:', error);
                            
                            // Try fallback parsing if OpenAI fails
                            if (voiceTranscript) {
                                console.log('üîÑ OpenAI failed, trying fallback parsing...');
                                const fallbackParsed = parseVoiceInputFallback(voiceTranscript);
                                if (Object.keys(fallbackParsed).length > 0) {
                                    setFormState(prev => ({ ...prev, ...fallbackParsed }));
                                    console.log('‚úÖ Fallback parsing successful:', fallbackParsed);
                                    setError('‚ö†Ô∏è Using fallback parsing (OpenAI unavailable)');
                                } else {
                                    setError(`üö´ Audio processing failed: ${error.message}`);
                                }
                            } else {
                                setError(`üö´ Audio processing failed: ${error.message}`);
                            }
                            setTimeout(() => setError(''), 8000);
                        }
                        stream.getTracks().forEach(track => track.stop());
                    };

                    // Mobile-friendly silence detection with relaxed settings
                    const recordingStartTime = performance.now();
                    const MIN_RECORDING_TIME = 1500; // Increased to 1.5s for mobile compatibility
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    
                    try {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                        sourceNodeRef.current = audioContextRef.current.createMediaStreamSource(stream);
                        analyserRef.current = audioContextRef.current.createAnalyser();
                        analyserRef.current.fftSize = 2048;
                        analyserRef.current.smoothingTimeConstant = 0.85; // More smoothing for mobile
                        sourceNodeRef.current.connect(analyserRef.current);

                        const buffer = new Uint8Array(analyserRef.current.fftSize);
                        // More lenient settings for mobile devices
                        const SILENCE_THRESHOLD = isMobile ? 15 : 20; 
                        const SILENCE_MS = isMobile ? 1500 : 1200; // Longer silence wait on mobile
                        let voiceDetected = false;
                        let voiceActivityCount = 0; // Count voice activity frames

                        const tick = () => {
                            if (!analyserRef.current) return; // Safety check
                            
                            analyserRef.current.getByteTimeDomainData(buffer);
                            let maxAmp = 0;
                            let avgAmp = 0;
                            for (let i = 0; i < buffer.length; i++) {
                                const amp = Math.abs(buffer[i] - 128);
                                maxAmp = Math.max(maxAmp, amp);
                                avgAmp += amp;
                            }
                            avgAmp /= buffer.length;
                            
                            const now = performance.now();
                            const recordingDuration = now - recordingStartTime;
                            
                            // Voice detected if either peak or average exceeds threshold
                            if (maxAmp > SILENCE_THRESHOLD || avgAmp > (SILENCE_THRESHOLD / 3)) {
                                lastVoiceTsRef.current = now;
                                voiceDetected = true;
                                voiceActivityCount++;
                                console.log(`üé§ Voice detected (max: ${maxAmp.toFixed(1)}, avg: ${avgAmp.toFixed(1)})`);
                            }
                            
                            const silenceDuration = now - lastVoiceTsRef.current;
                            
                            // Only stop if:
                            // 1. Minimum recording time passed
                            // 2. Voice was detected multiple times (not just noise)
                            // 3. Silence duration exceeded threshold
                            if (recordingDuration > MIN_RECORDING_TIME && 
                                voiceActivityCount > 5 && 
                                silenceDuration > SILENCE_MS) {
                                console.log(`üîá Silence detected after ${voiceActivityCount} voice frames, stopping recording`);
                                stopAudioRecording();
                                return;
                            }
                            
                            // Max recording time safety limit
                            if (recordingDuration > 30000) { // 30 seconds max
                                console.log('‚è±Ô∏è Maximum recording time reached');
                                stopAudioRecording();
                                return;
                            }
                            
                            silenceRAFRef.current = requestAnimationFrame(tick);
                        };
                        silenceRAFRef.current = requestAnimationFrame(tick);
                    } catch(e) {
                        console.warn('Silence detection unavailable:', e);
                    }

                    mediaRecorder.start();
                    setIsRecording(true);
                    setError('');
                    console.log(`üé§ Recording started (${isMobile ? 'Mobile' : 'Desktop'} mode)`);

                    // Longer timeout for mobile devices
                    if (autoVoiceMode) {
                        const timeout = isMobile ? 6000 : 5000; // 6s on mobile, 5s on desktop
                        recordingTimeoutRef.current = setTimeout(() => {
                            console.log('‚è±Ô∏è Auto timeout reached');
                            stopAudioRecording();
                        }, timeout);
                    }
                } catch (error) {
                    console.error('Recording error:', error);
                    let errorMsg = 'üé§ Recording failed';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMsg = 'üé§ Microphone permission denied. Please allow microphone access in your browser settings.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMsg = 'üé§ No microphone found. Please check your device settings.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMsg = 'üé§ Microphone is being used by another app. Please close other apps and try again.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMsg = 'üé§ Microphone constraints not supported. Trying basic mode...';
                    } else {
                        errorMsg = `üé§ Recording failed: ${error.message || 'Unknown error'}`;
                    }
                    
                    setError(errorMsg);
                    setTimeout(() => setError(''), 8000);
                }
            };

            const stopAudioRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    if (recordingTimeoutRef.current) {
                        clearTimeout(recordingTimeoutRef.current);
                        recordingTimeoutRef.current = null;
                    }
                    if (silenceRAFRef.current) {
                        cancelAnimationFrame(silenceRAFRef.current);
                        silenceRAFRef.current = null;
                    }
                    
                    // Clean up audio context and analyser
                    try {
                        if (sourceNodeRef.current) {
                            sourceNodeRef.current.disconnect();
                            sourceNodeRef.current = null;
                        }
                        if (analyserRef.current) {
                            analyserRef.current = null;
                        }
                        if (audioContextRef.current) {
                            audioContextRef.current.close();
                            audioContextRef.current = null;
                        }
                    } catch (e) {
                        console.warn('Audio context cleanup warning:', e);
                    }
                    
                    // Stop the media recorder and clean up stream
                    try {
                        if (mediaRecorderRef.current.state !== 'inactive') {
                            mediaRecorderRef.current.stop();
                        }
                        
                        // Clean up media stream tracks to free resources
                        if (mediaRecorderRef.current.stream) {
                            mediaRecorderRef.current.stream.getTracks().forEach(track => {
                                track.stop();
                                console.log('üîá Audio track stopped and freed');
                            });
                        }
                    } catch (e) {
                        console.warn('Media recorder cleanup warning:', e);
                    }
                    
                    setIsRecording(false);
                    console.log('‚úÖ Recording stopped and resources cleaned up');
                }
            };

            // Auto-start voice mode on page load
            useEffect(() => {
                const timer = setTimeout(async () => {
                    setAutoVoiceMode(true);
                    const gujaratiPrompt = '‡™µ‡´â‡™á‡™∏ ‡™Æ‡´ã‡™° ‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™•‡™Ø‡´ã ‡™õ‡´á. ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™°‡™æ‡™Ø‡™Æ‡™Ç‡™°‡™®‡´Ä ‡™ú‡™∞‡´Ç‡™∞‡™ø‡™Ø‡™æ‡™§‡´ã ‡™ú‡™£‡™æ‡™µ‡´ã.';
                    const englishPrompt = 'Voice mode activated. Tell me all your diamond requirements.';
                    const bilingualEndPrompt = '‡™ú‡´ç‡™Ø‡™æ‡™∞‡´á ‡™§‡™Æ‡´á ‡™™‡´Ç‡™∞‡´ç‡™£ ‡™ï‡™∞‡´ã ‡™§‡´ç‡™Ø‡™æ‡™∞‡´á ‡™ï‡™π‡´ã. When you are done, say stop to process.';

                    await speakAsync(gujaratiPrompt, { interrupt: true, rate: 1.1 });
                    await speakAsync(englishPrompt, { rate: 1.1 });
                    await speakAsync(bilingualEndPrompt, { rate: 1.0 });

                    setTimeout(() => {
                        setAutoVoiceMode(false);
                    }, 2000);

                    setTimeout(() => {
                        startAudioRecording();
                    }, 500);
                }, 1500);
                return () => clearTimeout(timer);
            }, []);

            // Check connection status
            useEffect(() => {
                const checkStatus = async () => {
                    const isOnline = await checkConnectivity();
                    setConnectionStatus(isOnline ? 'online' : 'offline');
                };
                checkStatus();
                const interval = setInterval(checkStatus, 30000);
                return () => clearInterval(interval);
            }, []);
            
            return (
                <div className="min-h-screen flex items-start justify-center p-4 sm:py-8 bg-gray-900">
                    <div className="w-full max-w-5xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
                        <div className="text-center mb-2 sm:mb-4">
                            <h1 className="text-xl sm:text-2xl md:text-3xl font-bold text-white">Diamond Requirement Form</h1>
                            <p className="text-gray-400 mt-1 text-xs sm:text-sm">Fill the form, click submit, and get a requirement ticket.</p>
                        </div>

                        {/* Voice Activation Section */}
                        <div className="mb-2 sm:mb-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-2 sm:p-4 text-center">
                            <div className="flex flex-col items-center space-y-1 sm:space-y-2">
                                <h2 className="text-sm sm:text-lg font-bold text-white">‚ö° Ultra-Fast Gemini Live</h2>
                                <p className="text-blue-100 text-xs sm:text-sm">ü§ñ AI-Powered Parsing! üåç Speak in ANY language</p>
                                <div className="text-xs text-blue-200">
                                    {connectionStatus === 'online' ? 'üü¢ Connected' : connectionStatus === 'offline' ? 'üî¥ No Internet' : 'üü° Checking...'}
                                </div>
                            </div>
                        </div>

                        {/* Temporary Voice Mode Popup */}
                        {autoVoiceMode && (
                            <div 
                                className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 cursor-pointer animate-fade-out"
                                onClick={() => setAutoVoiceMode(false)}
                            >
                                üé§ Voice Mode Activated
                                <span className="ml-2 text-xs">√ó</span>
                                <div className="text-xs mt-1">
                                    ‡™µ‡´â‡™á‡™∏ ‡™Æ‡´ã‡™° ‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™•‡™Ø‡´ã ‡™õ‡´á. Voice mode activated.
                                </div>
                            </div>
                        )}

                        {/* Voice Interface */}
                        {isRecording && (
                            <div className="mb-4 bg-gradient-to-r from-red-600 to-red-700 rounded-lg p-4 text-center shadow-lg border-2 border-red-400 animate-pulse">
                                <div className="flex items-center justify-center mb-2">
                                    <div className="w-4 h-4 bg-white rounded-full mr-2 animate-pulse"></div>
                                    <div className="text-white font-bold text-lg">
                                        üé§ LISTENING NOW...
                                    </div>
                                    <div className="w-4 h-4 bg-white rounded-full ml-2 animate-pulse"></div>
                                </div>
                                <div className="text-red-100 text-sm mb-2 font-medium">
                                    {autoVoiceMode ? 'Speak ALL your diamond requirements clearly' : 'Speak your diamond requirements clearly'}
                                </div>
                                <div className="text-red-200 text-xs mb-3">
                                    üí° Tip: Speak clearly and wait 1 second after finishing
                                </div>
                                <button
                                    onClick={stopAudioRecording}
                                    className="bg-white text-red-600 hover:bg-red-100 font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg text-base"
                                >
                                    <i className="fas fa-stop-circle mr-2"></i>TAP TO STOP
                                </button>
                            </div>
                        )}

                        {isProcessing && (
                            <div className="mb-4 bg-yellow-600 rounded-lg p-3 text-center">
                                <div className="text-white font-semibold mb-2">
                                    ‚ö° Processing...
                                </div>
                                <div className="text-yellow-200 text-sm mb-2">
                                    {autoVoiceMode ? 'AI parsing your requirements' : 'Transcribing audio'}
                                </div>
                                <div className="flex justify-center space-x-2">
                                    <div className="w-2 h-2 bg-yellow-300 rounded-full animate-pulse"></div>
                                    <div className="w-2 h-2 bg-yellow-300 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                                    <div className="w-2 h-2 bg-yellow-300 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
                                </div>
                                <div className="text-yellow-100 text-xs mt-2">
                                    This should take 2-3 seconds...
                                </div>
                            </div>
                        )}

                        {voiceTranscript && (
                            <div className="mb-4 bg-blue-600 rounded-lg p-3">
                                <div className="text-white font-semibold mb-2">You said:</div>
                                <div className="text-blue-200 text-sm mb-2">"{voiceTranscript}"</div>
                                {isProcessing ? (
                                    <div className="text-yellow-300 text-sm flex items-center">
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                        AI is parsing your requirements...
                                    </div>
                                ) : (
                                    <div className="text-green-300 text-sm">‚úì Processing completed!</div>
                                )}
                            </div>
                        )}

                        {/* Form Content */}
                        <div className="grid md:grid-cols-2 gap-8">
                            {/* Input Form Section */}
                            <div>
                               <form onSubmit={handleSubmit}>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Shape</label>
                                            <input
                                                name="shape"
                                                value={formState.shape}
                                                onChange={handleInputChange}
                                                placeholder="e.g., round, oval, custom"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Sizes (mm)</label>
                                            <input
                                                name="sizes_mm"
                                                value={formState.sizes_mm}
                                                onChange={handleInputChange}
                                                placeholder="e.g., 1.0-1.2"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Color</label>
                                            <input
                                                name="color"
                                                value={formState.color}
                                                onChange={handleInputChange}
                                                placeholder="e.g., G-H, D"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Clarity</label>
                                            <input
                                                name="clarity"
                                                value={formState.clarity}
                                                onChange={handleInputChange}
                                                placeholder="e.g., VVS-VS, IF, BS"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Carats (ct)</label>
                                            <input
                                                name="carats_ct"
                                                value={formState.carats_ct}
                                                onChange={handleInputChange}
                                                placeholder="e.g., 0.50"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Price Target (INR)</label>
                                            <input
                                                name="price_target_inr"
                                                value={formState.price_target_inr}
                                                onChange={handleInputChange}
                                                placeholder="e.g., 50000"
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        <div className="sm:col-span-2">
                                            <label className="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                                            <textarea
                                                name="notes"
                                                rows="3"
                                                value={formState.notes}
                                                onChange={handleInputChange}
                                                placeholder="Any additional notes..."
                                                className="w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-gray-200 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                            />
                                            </div>
                                        </div>
                                    {error && (
                                        <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-3 mt-3">
                                            <p className="text-red-400 text-sm text-center whitespace-pre-line">{error}</p>
                                    </div>
                                    )}
                                    <button type="submit" className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center shadow-lg">
                                        <i className="fas fa-paper-plane mr-2"></i> Submit
                                    </button>
                                    
                                    {/* New Requirement Button */}
                                    <button 
                                        type="button" 
                                        onClick={handleNewRequirement}
                                        className="mt-3 w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg"
                                    >
                                        <i className="fas fa-plus mr-2"></i> New Requirement
                                    </button>
                               </form>
                            </div>

                            {/* Output Section */}
                            <div className="flex flex-col">
                                <div className="relative flex-grow bg-gray-900 rounded-lg h-full min-h-[300px]">
                                    {submittedData ? (
                                        <div className="p-6 text-white">
                                            <h3 className="text-xl font-bold mb-4">üìã Requirement Ticket</h3>
                                            <div className="space-y-2">
                                                {Object.entries(submittedData).map(([key, value]) => (
                                                    <div key={key} className="flex justify-between">
                                                        <span className="capitalize text-gray-300">{key.replace('_', ' ')}:</span>
                                                        <span className="text-yellow-400">{value}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <button
                                                onClick={handleClear}
                                                className="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300"
                                            >
                                                <i className="fas fa-times mr-2"></i>Clear
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-gray-500 text-center p-4">
                                            Your requirement ticket will appear here after you click "Submit".
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Mobile Number Popup - Mobile Optimized */}
                        {showMobilePopup && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
                                <div className="bg-gray-800 rounded-xl p-4 sm:p-6 w-full max-w-md border border-yellow-500/30 shadow-2xl max-h-[95vh] overflow-y-auto mobile-scroll">
                                    <button 
                                        onClick={() => setShowMobilePopup(false)}
                                        className="absolute top-4 right-4 w-8 h-8 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center text-lg font-bold transition-colors duration-300"
                                    >
                                        √ó
                                    </button>

                                    <div className="text-center mb-6">
                                        {/* Animated Voice Icon */}
                                        {isRecordingMobile ? (
                                            <div className="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center shadow-lg pulse">
                                                <i className="fas fa-microphone text-white text-2xl animate-pulse"></i>
                                            </div>
                                        ) : (
                                            <div className="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center shadow-lg">
                                                <i className="fas fa-phone text-white text-xl"></i>
                                            </div>
                                        )}
                                        <h3 className="text-xl font-bold text-yellow-400 mb-2">
                                            üì± Mobile Number Required
                                            {isRecordingMobile && <span className="ml-2 text-red-400 text-sm">üé§ Listening...</span>}
                                        </h3>
                                        <p className="text-sm text-gray-400 mb-2">‚ö†Ô∏è Mobile number is MANDATORY to save your requirements</p>
                                        <p className="text-xs text-red-400">Without mobile number, your data will NOT be saved to database</p>
                                        {isRecordingMobile && (
                                            <p className="text-xs text-green-400 mt-2 font-semibold animate-pulse">
                                                üéôÔ∏è Speak your 10-digit mobile number now...
                                            </p>
                                        )}
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-300 mb-2">
                                            Mobile Number 
                                            {isRecordingMobile && <span className="ml-2 text-red-400">üé§ Listening...</span>}
                                        </label>
                                        <input
                                            type="tel"
                                            inputMode="numeric"
                                            pattern="[0-9]*"
                                            value={mobileNumber}
                                            onChange={(e) => setMobileNumber(e.target.value)}
                                            placeholder="Speak your number or type here"
                                            className="w-full p-3 sm:p-4 text-base sm:text-lg bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                                            maxLength="10"
                                        />
                                        
                                        {/* Auto-recording status and instructions */}
                                        {!isRecordingMobile && !isProcessingMobile && !mobileNumber && (
                                            <div className="mt-2 p-2 bg-blue-900 rounded text-center">
                                                <div className="text-xs text-blue-200 font-semibold mb-1">
                                                    üí° HOW TO SPEAK YOUR NUMBER:
                                                </div>
                                                <div className="text-xs text-gray-300">
                                                    Say it clearly: "9 8 7 6 5 4 3 2 1 0"<br/>
                                                    OR say: "Nine Eight Seven Six Five Four Three Two One Zero"<br/>
                                                    OR say groups: "Nine Eight Seven, Six Five Four, Three Two One Zero"
                                                </div>
                                            </div>
                                        )}
                                        
                                        {isProcessingMobile && (
                                            <div className="mt-2 p-2 bg-yellow-600 rounded text-center">
                                                <div className="text-white text-sm">‚ö° Processing your voice...</div>
                                            </div>
                                        )}
                                        
                                        {mobileTranscript && (
                                            <div className="mt-2 p-2 bg-blue-600 rounded">
                                                <div className="text-white text-xs">
                                                    {mobileTranscript.includes('Found saved number') ? mobileTranscript : `You said: "${mobileTranscript}"`}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <button
                                            onClick={async () => {
                                                if (mobileNumber.length === 10) {
                                                    try {
                                                        // Save mobile number (handles duplicates gracefully)
                                                        await saveMobileNumber(mobileNumber);
                                                        
                                                        // Save requirement data
                                                        let savedData = null;
                                                        if (submittedData) {
                                                            savedData = await saveDiamondRequirement(submittedData, mobileNumber);
                                                        }
                                                        
                                                        // Generate ticket number
                                                        const newTicketNumber = `DR${Date.now().toString().slice(-6)}`;
                                                        setTicketNumber(newTicketNumber);
                                                        
                                                        // Set saved requirement for ticket display
                                                        setSavedRequirement({
                                                            ...submittedData,
                                                            mobile_number: mobileNumber,
                                                            ticket_number: newTicketNumber,
                                                            created_at: new Date().toLocaleString()
                                                        });
                                                        
                                                        // Close popup and show ticket
                                                        setShowMobilePopup(false);
                                                        setShowRequirementTicket(true);
                                                        setMobileNumber('');
                                                        
                                                        // Show success message
                                                        alert(`‚úÖ Data saved successfully! Your ticket number is: ${newTicketNumber}`);
                                                        
                                                    } catch (error) {
                                                        console.error('Error saving data:', error);
                                                        if (error.code === '23505') {
                                                            alert('‚úÖ Mobile number already exists in our database. Requirement saved successfully!');
                                                            // Still show the ticket even if mobile number was duplicate
                                                            const newTicketNumber = `DR${Date.now().toString().slice(-6)}`;
                                                            setTicketNumber(newTicketNumber);
                                                            setSavedRequirement({
                                                                ...submittedData,
                                                                mobile_number: mobileNumber,
                                                                ticket_number: newTicketNumber,
                                                                created_at: new Date().toLocaleString()
                                                            });
                                                            setShowMobilePopup(false);
                                                            setShowRequirementTicket(true);
                                                            setMobileNumber('');
                                                        } else {
                                                            alert('‚ùå Failed to save data. Please check your internet connection and try again.');
                                                        }
                                                    }
                                                } else {
                                                    alert('‚ö†Ô∏è Please enter a valid 10-digit mobile number');
                                                }
                                            }}
                                            className="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-300 text-base sm:text-lg"
                                        >
                                            <i className="fas fa-check mr-2"></i>Save & Continue
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowMobilePopup(false);
                                                setSubmittedData(null);
                                                alert('‚ö†Ô∏è Data not saved - mobile number is required');
                                            }}
                                            className="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-300 text-base sm:text-lg"
                                        >
                                            <i className="fas fa-times mr-2"></i>Skip (No Save)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Requirement Ticket Modal */}
                        {showRequirementTicket && savedRequirement && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
                                <div className="bg-white rounded-xl p-6 w-full max-w-2xl border-2 border-blue-500 shadow-2xl max-h-[95vh] overflow-y-auto mobile-scroll">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                                            <i className="fas fa-ticket-alt text-blue-600 mr-3"></i>
                                            Requirement Ticket
                                        </h2>
                                        <button 
                                            onClick={() => setShowRequirementTicket(false)}
                                            className="w-8 h-8 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center text-lg font-bold transition-colors duration-300"
                                        >
                                            √ó
                                        </button>
                                    </div>

                                    {/* Ticket Content */}
                                    <div id="requirement-ticket" className="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-lg border-2 border-blue-200 mb-6">
                                        <div className="text-center mb-6">
                                            <div className="inline-block bg-blue-600 text-white px-6 py-2 rounded-full text-lg font-bold mb-2">
                                                Ticket #{savedRequirement.ticket_number}
                                            </div>
                                            <p className="text-gray-600 text-sm">Created: {savedRequirement.created_at}</p>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-white p-4 rounded-lg border">
                                                <h3 className="font-bold text-gray-800 mb-3 flex items-center">
                                                    <i className="fas fa-gem text-blue-600 mr-2"></i>
                                                    Diamond Specifications
                                                </h3>
                                                <div className="space-y-2 text-sm">
                                                    {savedRequirement.shape && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Shape:</span>
                                                            <span className="text-gray-800">{savedRequirement.shape}</span>
                                                        </div>
                                                    )}
                                                    {savedRequirement.sizes_mm && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Size (mm):</span>
                                                            <span className="text-gray-800">{savedRequirement.sizes_mm}</span>
                                                        </div>
                                                    )}
                                                    {savedRequirement.color && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Color:</span>
                                                            <span className="text-gray-800">{savedRequirement.color}</span>
                                                        </div>
                                                    )}
                                                    {savedRequirement.clarity && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Clarity:</span>
                                                            <span className="text-gray-800">{savedRequirement.clarity}</span>
                                                        </div>
                                                    )}
                                                    {savedRequirement.carats_ct && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Carats:</span>
                                                            <span className="text-gray-800">{savedRequirement.carats_ct} ct</span>
                                                        </div>
                                                    )}
                                                    {savedRequirement.price_target_inr && (
                                                        <div className="flex justify-between">
                                                            <span className="font-medium text-gray-600">Price Target:</span>
                                                            <span className="text-gray-800">‚Çπ{savedRequirement.price_target_inr}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="bg-white p-4 rounded-lg border">
                                                <h3 className="font-bold text-gray-800 mb-3 flex items-center">
                                                    <i className="fas fa-user text-green-600 mr-2"></i>
                                                    Contact Information
                                                </h3>
                                                <div className="space-y-2 text-sm">
                                                    <div className="flex justify-between">
                                                        <span className="font-medium text-gray-600">Mobile:</span>
                                                        <span className="text-gray-800">+91 {savedRequirement.mobile_number}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="font-medium text-gray-600">Status:</span>
                                                        <span className="text-green-600 font-medium">Active</span>
                                                    </div>
                                                </div>
                                                
                                                {savedRequirement.notes && (
                                                    <div className="mt-4">
                                                        <h4 className="font-medium text-gray-600 mb-2">Additional Notes:</h4>
                                                        <p className="text-gray-800 text-sm bg-gray-50 p-3 rounded border">
                                                            {savedRequirement.notes}
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="mt-6 text-center">
                                            <div className="inline-block bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-2 rounded-lg text-sm">
                                                <i className="fas fa-info-circle mr-2"></i>
                                                Keep this ticket number for reference. Our team will contact you within 24 hours.
                                            </div>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        {/* Desktop/Laptop Only - Download and Share buttons */}
                                        <div className="hidden md:flex flex-col sm:flex-row gap-3 w-full">
                                            <button
                                                onClick={() => downloadTicketAsPNG()}
                                                className="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base download-btn"
                                            >
                                                <i className="fas fa-download mr-2"></i>Download as PNG
                                            </button>
                                            <button
                                                onClick={() => shareTicket()}
                                                className="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base share-btn"
                                            >
                                                <i className="fas fa-share mr-2"></i>Share Ticket
                                            </button>
                                        </div>
                                        
                                        {/* Mobile Only - Screenshot instructions */}
                                        <div className="md:hidden w-full">
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                                                <div className="flex items-center mb-2">
                                                    <i className="fas fa-mobile-alt text-blue-600 mr-2"></i>
                                                    <span className="font-semibold text-blue-800">Mobile Instructions</span>
                                                </div>
                                                <p className="text-sm text-blue-700 mb-2">
                                                    üì∏ <strong>Take a screenshot</strong> of this ticket to save it
                                                </p>
                                                <p className="text-sm text-blue-700">
                                                    üìã Check <strong>"My Deals"</strong> page to view all your saved requirements
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {/* Close button - Always visible */}
                                        <button
                                            onClick={handleCloseTicket}
                                            className="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base"
                                        >
                                            <i className="fas fa-times mr-2"></i>Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Close Popup Modal */}
                        {showClosePopup && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                    <div className="text-center">
                                        <div className="mb-4">
                                            <i className="fas fa-question-circle text-4xl text-blue-600 mb-3"></i>
                                            <h3 className="text-xl font-semibold text-gray-800 mb-2">What would you like to do?</h3>
                                            <p className="text-gray-600">Choose your next action:</p>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => handleClosePopupOption('new')}
                                                className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base flex items-center justify-center"
                                            >
                                                <i className="fas fa-plus mr-2"></i>
                                                Start New Requirement
                                            </button>
                                            
                                            <button
                                                onClick={() => handleClosePopupOption('stop')}
                                                className="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base flex items-center justify-center"
                                            >
                                                <i className="fas fa-stop mr-2"></i>
                                                Stop Voice & Close
                                            </button>
                                            
                                            <button
                                                onClick={() => setShowClosePopup(false)}
                                                className="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 text-base flex items-center justify-center"
                                            >
                                                <i className="fas fa-times mr-2"></i>
                                                Cancel
                                            </button>
                                        </div>
                                        
                                        <div className="mt-4 text-sm text-gray-500">
                                            <p><strong>New Requirement:</strong> Clears everything and starts fresh</p>
                                            <p><strong>Stop Voice:</strong> Just closes ticket and stops voice</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Deals Page Component
        const DealsPage = () => {
            const [searchMobileNumber, setSearchMobileNumber] = useState('');
            const [userDeals, setUserDeals] = useState(null);
            const [isSearchingDeals, setIsSearchingDeals] = useState(false);

            const handleSearchDeals = async () => {
                if (searchMobileNumber.length !== 10) {
                    alert('Please enter a valid 10-digit mobile number');
                    return;
                }

                try {
                    setIsSearchingDeals(true);
                    const deals = await fetchUserDeals(searchMobileNumber);
                    setUserDeals(deals);
                } catch (error) {
                    alert('Error fetching deals. Please try again.');
                    setUserDeals(null);
                } finally {
                    setIsSearchingDeals(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-900 py-8">
                    <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center shadow-lg">
                                <i className="fas fa-gem text-white text-2xl"></i>
                            </div>
                            <h1 className="text-3xl font-bold text-yellow-400 mb-2">üíé My Diamond Deals</h1>
                            <p className="text-gray-400">Enter your mobile number to view your diamond requirements</p>
                        </div>

                        {/* Mobile Number Search */}
                        <div className="bg-gray-800 rounded-xl p-6 mb-8 border border-gray-700">
                            <div className="flex flex-col sm:flex-row gap-4">
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Mobile Number</label>
                                    <input
                                        type="tel"
                                        value={searchMobileNumber}
                                        onChange={(e) => setSearchMobileNumber(e.target.value)}
                                        placeholder="Enter your 10-digit mobile number"
                                        className="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                                        maxLength="10"
                                    />
                                </div>
                                <div className="flex items-end">
                                    <button
                                        onClick={handleSearchDeals}
                                        disabled={isSearchingDeals || searchMobileNumber.length !== 10}
                                        className={`px-6 py-3 rounded-lg font-semibold transition-all duration-300 ${
                                            isSearchingDeals || searchMobileNumber.length !== 10
                                                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                                : 'bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white shadow-lg hover:shadow-xl'
                                        }`}
                                    >
                                        {isSearchingDeals ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin mr-2"></i>
                                                Searching...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-search mr-2"></i>
                                                Search Deals
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Results */}
                        {userDeals && (
                            <div className="space-y-6">
                                <div className="text-center">
                                    <h2 className="text-xl font-semibold text-white mb-2">
                                        Found {userDeals.length} deal{userDeals.length !== 1 ? 's' : ''}
                                    </h2>
                                    <p className="text-gray-400">Mobile: {searchMobileNumber}</p>
                                </div>

                                {userDeals.length > 0 ? (
                                    <div className="grid gap-6">
                                        {userDeals.map((deal, index) => (
                                            <div key={deal.id} className="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-yellow-500/50 transition-colors">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center">
                                                        <div className="w-10 h-10 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center mr-3">
                                                            <span className="text-white font-bold">{index + 1}</span>
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold text-white">Deal #{deal.id}</h3>
                                                            <p className="text-sm text-gray-400">
                                                                {new Date(deal.created_at).toLocaleDateString('en-US', {
                                                                    year: 'numeric',
                                                                    month: 'long',
                                                                    day: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                })}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-sm text-gray-400">Status</div>
                                                        <div className="text-green-400 font-semibold">‚úÖ Active</div>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                                    {deal.shape && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Shape</div>
                                                            <div className="text-white font-semibold">{deal.shape}</div>
                                                        </div>
                                                    )}
                                                    {deal.carats_ct && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Carats</div>
                                                            <div className="text-white font-semibold">{deal.carats_ct} ct</div>
                                                        </div>
                                                    )}
                                                    {deal.color && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Color</div>
                                                            <div className="text-white font-semibold">{deal.color}</div>
                                                        </div>
                                                    )}
                                                    {deal.clarity && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Clarity</div>
                                                            <div className="text-white font-semibold">{deal.clarity}</div>
                                                        </div>
                                                    )}
                                                    {deal.price_target_inr && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Price Target</div>
                                                            <div className="text-white font-semibold">‚Çπ{deal.price_target_inr}</div>
                                                        </div>
                                                    )}
                                                    {deal.sizes_mm && (
                                                        <div className="bg-gray-900/50 rounded-lg p-3">
                                                            <div className="text-xs text-gray-400 uppercase tracking-wider">Size</div>
                                                            <div className="text-white font-semibold">{deal.sizes_mm} mm</div>
                                                        </div>
                                                    )}
                                                </div>

                                                {deal.notes && (
                                                    <div className="mt-4 p-3 bg-gray-900/30 rounded-lg">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">Additional Notes</div>
                                                        <div className="text-gray-200 text-sm">{deal.notes}</div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center">
                                            <i className="fas fa-search text-gray-400 text-2xl"></i>
                                        </div>
                                        <h3 className="text-xl font-semibold text-gray-400 mb-2">No deals found</h3>
                                        <p className="text-gray-500">No diamond requirements found for this mobile number.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* No search yet */}
                        {!userDeals && (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center">
                                    <i className="fas fa-mobile-alt text-gray-400 text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-semibold text-gray-400 mb-2">Search Your Deals</h3>
                                <p className="text-gray-500">Enter your mobile number above to view your diamond requirements.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Admin Page Component
        const AdminPage = () => {
            const [adminPassword, setAdminPassword] = useState('');
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [allDeals, setAllDeals] = useState([]);
            const [isLoadingAdmin, setIsLoadingAdmin] = useState(false);
            const ADMIN_PASSWORD = 'diamond2024';

            const handleAdminLogin = async () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdminAuthenticated(true);
                    try {
                        setIsLoadingAdmin(true);
                        const deals = await fetchAllDeals();
                        setAllDeals(deals);
                    } catch (error) {
                        alert('Error loading deals');
                    } finally {
                        setIsLoadingAdmin(false);
                    }
                } else {
                    alert('‚ùå Invalid admin password');
                    setAdminPassword('');
                }
            };

            if (!isAdminAuthenticated) {
                return (
                    <div className="min-h-screen bg-gray-900 py-8">
                        <div className="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="bg-gray-800 rounded-xl p-8 border border-gray-700">
                                <div className="text-center mb-8">
                                    <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center shadow-lg">
                                        <i className="fas fa-shield-alt text-white text-2xl"></i>
                                    </div>
                                    <h1 className="text-2xl font-bold text-white mb-2">üîê Admin Access</h1>
                                    <p className="text-gray-400">Enter admin password to access dashboard</p>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-2">Admin Password</label>
                                        <input
                                            type="password"
                                            value={adminPassword}
                                            onChange={(e) => setAdminPassword(e.target.value)}
                                            placeholder="Enter admin password"
                                            className="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                            onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                        />
                                    </div>
                                    <button
                                        onClick={handleAdminLogin}
                                        className="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300"
                                    >
                                        <i className="fas fa-sign-in-alt mr-2"></i>
                                        Login to Admin
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Group deals by date
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const todayDeals = allDeals.filter(deal => new Date(deal.created_at).toDateString() === today);
            const yesterdayDeals = allDeals.filter(deal => new Date(deal.created_at).toDateString() === yesterday);
            const otherDeals = allDeals.filter(deal => {
                const dealDate = new Date(deal.created_at).toDateString();
                return dealDate !== today && dealDate !== yesterday;
            });

            return (
                <div className="min-h-screen bg-gray-900 py-8">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        {/* Header */}
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-white mb-2">üìä Admin Dashboard</h1>
                                <p className="text-gray-400">Diamond requirements management</p>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="text-right">
                                    <div className="text-sm text-gray-400">Total Deals</div>
                                    <div className="text-2xl font-bold text-yellow-400">{allDeals.length}</div>
                                </div>
                                <button
                                    onClick={() => {
                                        setIsAdminAuthenticated(false);
                                        setAdminPassword('');
                                    }}
                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
                                >
                                    <i className="fas fa-sign-out-alt mr-2"></i>
                                    Logout
                                </button>
                            </div>
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-green-200 text-sm">Today's Deals</div>
                                        <div className="text-3xl font-bold">{todayDeals.length}</div>
                                    </div>
                                    <i className="fas fa-calendar-day text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-blue-200 text-sm">Yesterday's Deals</div>
                                        <div className="text-3xl font-bold">{yesterdayDeals.length}</div>
                                    </div>
                                    <i className="fas fa-calendar-minus text-4xl opacity-50"></i>
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-purple-200 text-sm">Total Revenue</div>
                                        <div className="text-3xl font-bold">
                                            ‚Çπ{allDeals.reduce((sum, deal) => sum + (parseInt(deal.price_target_inr) || 0), 0).toLocaleString()}
                                        </div>
                                    </div>
                                    <i className="fas fa-rupee-sign text-4xl opacity-50"></i>
                                </div>
                            </div>
                        </div>

                        {/* Loading State */}
                        {isLoadingAdmin && (
                            <div className="text-center py-12">
                                <i className="fas fa-spinner fa-spin text-4xl text-yellow-400 mb-4"></i>
                                <p className="text-gray-400">Loading deals...</p>
                            </div>
                        )}

                        {/* Today's Deals */}
                        {todayDeals.length > 0 && (
                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                    <i className="fas fa-sun text-yellow-400 mr-3"></i>
                                    Today's Deals ({todayDeals.length})
                                </h2>
                                <div className="grid gap-4">
                                    {todayDeals.map((deal) => (
                                        <div key={deal.id} className="bg-gray-800 rounded-xl p-6 border border-green-500/50 transition-all hover:shadow-lg">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center">
                                                    <div className="w-12 h-12 rounded-full flex items-center justify-center mr-4 bg-green-500">
                                                        <span className="text-white font-bold text-lg">#{deal.id}</span>
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold text-white">
                                                            {deal.mobile_number ? `üì± ${deal.mobile_number}` : 'üì± No Mobile'}
                                                        </h3>
                                                        <p className="text-sm text-gray-400">
                                                            {new Date(deal.created_at).toLocaleDateString('en-US', {
                                                                weekday: 'long',
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-sm text-gray-400">Price Target</div>
                                                    <div className="text-lg font-bold text-yellow-400">
                                                        {deal.price_target_inr ? `‚Çπ${deal.price_target_inr}` : 'Not specified'}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                                {deal.shape && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Shape</div>
                                                        <div className="text-white font-semibold">{deal.shape}</div>
                                                    </div>
                                                )}
                                                {deal.carats_ct && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Carats</div>
                                                        <div className="text-white font-semibold">{deal.carats_ct} ct</div>
                                                    </div>
                                                )}
                                                {deal.color && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Color</div>
                                                        <div className="text-white font-semibold">{deal.color}</div>
                                                    </div>
                                                )}
                                                {deal.clarity && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Clarity</div>
                                                        <div className="text-white font-semibold">{deal.clarity}</div>
                                                    </div>
                                                )}
                                            </div>

                                            {deal.notes && (
                                                <div className="mt-4 p-3 bg-gray-900/30 rounded-lg">
                                                    <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">Notes</div>
                                                    <div className="text-gray-200 text-sm">{deal.notes}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Yesterday's Deals */}
                        {yesterdayDeals.length > 0 && (
                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                    <i className="fas fa-moon text-blue-400 mr-3"></i>
                                    Yesterday's Deals ({yesterdayDeals.length})
                                </h2>
                                <div className="grid gap-4">
                                    {yesterdayDeals.map((deal) => (
                                        <div key={deal.id} className="bg-gray-800 rounded-xl p-6 border border-gray-700 transition-all hover:shadow-lg">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center">
                                                    <div className="w-12 h-12 rounded-full flex items-center justify-center mr-4 bg-gray-600">
                                                        <span className="text-white font-bold text-lg">#{deal.id}</span>
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold text-white">
                                                            {deal.mobile_number ? `üì± ${deal.mobile_number}` : 'üì± No Mobile'}
                                                        </h3>
                                                        <p className="text-sm text-gray-400">
                                                            {new Date(deal.created_at).toLocaleDateString('en-US', {
                                                                weekday: 'long',
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-sm text-gray-400">Price Target</div>
                                                    <div className="text-lg font-bold text-yellow-400">
                                                        {deal.price_target_inr ? `‚Çπ${deal.price_target_inr}` : 'Not specified'}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                                {deal.shape && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Shape</div>
                                                        <div className="text-white font-semibold">{deal.shape}</div>
                                                    </div>
                                                )}
                                                {deal.carats_ct && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Carats</div>
                                                        <div className="text-white font-semibold">{deal.carats_ct} ct</div>
                                                    </div>
                                                )}
                                                {deal.color && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Color</div>
                                                        <div className="text-white font-semibold">{deal.color}</div>
                                                    </div>
                                                )}
                                                {deal.clarity && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Clarity</div>
                                                        <div className="text-white font-semibold">{deal.clarity}</div>
                                                    </div>
                                                )}
                                            </div>

                                            {deal.notes && (
                                                <div className="mt-4 p-3 bg-gray-900/30 rounded-lg">
                                                    <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">Notes</div>
                                                    <div className="text-gray-200 text-sm">{deal.notes}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Other Deals */}
                        {otherDeals.length > 0 && (
                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                    <i className="fas fa-history text-gray-400 mr-3"></i>
                                    Previous Deals ({otherDeals.length})
                                </h2>
                                <div className="grid gap-4">
                                    {otherDeals.map((deal) => (
                                        <div key={deal.id} className="bg-gray-800 rounded-xl p-6 border border-gray-700 transition-all hover:shadow-lg">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center">
                                                    <div className="w-12 h-12 rounded-full flex items-center justify-center mr-4 bg-gray-600">
                                                        <span className="text-white font-bold text-lg">#{deal.id}</span>
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-semibold text-white">
                                                            {deal.mobile_number ? `üì± ${deal.mobile_number}` : 'üì± No Mobile'}
                                                        </h3>
                                                        <p className="text-sm text-gray-400">
                                                            {new Date(deal.created_at).toLocaleDateString('en-US', {
                                                                weekday: 'long',
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-sm text-gray-400">Price Target</div>
                                                    <div className="text-lg font-bold text-yellow-400">
                                                        {deal.price_target_inr ? `‚Çπ${deal.price_target_inr}` : 'Not specified'}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                                {deal.shape && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Shape</div>
                                                        <div className="text-white font-semibold">{deal.shape}</div>
                                                    </div>
                                                )}
                                                {deal.carats_ct && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Carats</div>
                                                        <div className="text-white font-semibold">{deal.carats_ct} ct</div>
                                                    </div>
                                                )}
                                                {deal.color && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Color</div>
                                                        <div className="text-white font-semibold">{deal.color}</div>
                                                    </div>
                                                )}
                                                {deal.clarity && (
                                                    <div className="bg-gray-900/50 rounded-lg p-3">
                                                        <div className="text-xs text-gray-400 uppercase tracking-wider">Clarity</div>
                                                        <div className="text-white font-semibold">{deal.clarity}</div>
                                                    </div>
                                                )}
                                            </div>

                                            {deal.notes && (
                                                <div className="mt-4 p-3 bg-gray-900/30 rounded-lg">
                                                    <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">Notes</div>
                                                    <div className="text-gray-200 text-sm">{deal.notes}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* No deals */}
                        {allDeals.length === 0 && !isLoadingAdmin && (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center">
                                    <i className="fas fa-inbox text-gray-400 text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-semibold text-gray-400 mb-2">No deals found</h3>
                                <p className="text-gray-500">No diamond requirements have been submitted yet.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [showMobileMenu, setShowMobileMenu] = useState(false);

            const renderCurrentPage = () => {
                switch (currentPage) {
                    case 'home':
                        return <HomePage />;
                    case 'deals':
                        return <DealsPage />;
                    case 'admin':
                        return <AdminPage />;
                    default:
                        return (
                            <div className="min-h-screen flex items-center justify-center bg-gray-900">
                                <div className="text-center">
                                    <h1 className="text-2xl font-bold text-white mb-4">Page Not Found</h1>
                                    <button
                                        onClick={() => setCurrentPage('home')}
                                        className="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg transition-colors"
                                    >
                                        Go Home
                                    </button>
                                </div>
                            </div>
                        );
                }
            };

            return (
                <div className="min-h-screen bg-gray-900">
                    <Navigation 
                        currentPage={currentPage} 
                        setCurrentPage={setCurrentPage}
                        showMobileMenu={showMobileMenu}
                        setShowMobileMenu={setShowMobileMenu}
                    />
                    {renderCurrentPage()}
                </div>
            );
        };

        // Render the app
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
